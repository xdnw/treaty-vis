var mr=Object.defineProperty;var yr=(de,be,ze)=>be in de?mr(de,be,{enumerable:!0,configurable:!0,writable:!0,value:ze}):de[be]=ze;var W=(de,be,ze)=>yr(de,typeof be!="symbol"?be+"":be,ze);(function(){"use strict";function de(s,e,t,n,o){const r=Number(s==null?void 0:s[e]);return Number.isFinite(r)?Math.min(o,Math.max(n,r)):t}const be=Math.PI*2,ze=Math.PI*(3-Math.sqrt(5));class ts{constructor(){W(this,"strategy","fa2line")}run(e){const t=this.asState(e.previousState),n=this.buildSortedAdjacency(e.nodeIds,e.adjacencyByNodeId),o=this.computeConnectedComponents(e.nodeIds,n),r=this.assignStableComponentIds(o,t),i=[],a=[],c=[],d={anchors:{},nodePositions:{},components:[]};for(const l of r){const u=l.componentId,f=this.resolveComponentAnchor(u,l.nodeIds.length,t);d.anchors[u]=f,d.components.push({componentId:u,members:new Set(l.nodeIds),anchorX:f.x,anchorY:f.y}),i.push({componentId:u,nodeIds:l.nodeIds,anchorX:f.x,anchorY:f.y});const y=`${u}:community:0`;a.push({communityId:y,componentId:u,nodeIds:l.nodeIds,anchorX:f.x,anchorY:f.y});const h=this.seedPositions(l.nodeIds,y,f,t),m=this.solveComponentPositions(l.nodeIds,n,f,h,e);for(const[g,x]of m.entries())d.nodePositions[g]=x;const p=new Set(l.nodeIds);for(const g of l.nodeIds){const x=m.get(g)??f,_=n.get(g)??[];let I=0,P=0,M=0;for(const N of _){if(!p.has(N))continue;const R=m.get(N);R&&(I+=R.x,P+=R.y,M+=1)}M===0?(I=x.x,P=x.y):(I/=M,P/=M),c.push({nodeId:g,componentId:u,communityId:y,targetX:x.x,targetY:x.y,neighborX:I,neighborY:P,anchorX:f.x,anchorY:f.y})}}return c.sort((l,u)=>l.nodeId.localeCompare(u.nodeId)),{layout:{components:i,communities:a,nodeTargets:c},metadata:{state:d}}}asState(e){if(!e||typeof e!="object")return{anchors:{},nodePositions:{},components:[]};const t=e;return{anchors:this.toPointRecord(t.anchors),nodePositions:this.toPointRecord(t.nodePositions),components:this.toComponentSnapshots(t.components)}}toComponentSnapshots(e){if(!Array.isArray(e))return[];const t=[];for(const n of e){if(!n||typeof n!="object")continue;const o=n;if(typeof o.componentId!="string")continue;const r=Number(o.anchorX),i=Number(o.anchorY);if(!Number.isFinite(r)||!Number.isFinite(i))continue;const a=new Set;if(Array.isArray(o.members)||o.members instanceof Set)for(const c of o.members)typeof c=="string"&&a.add(c);t.push({componentId:o.componentId,members:a,anchorX:r,anchorY:i})}return t}toPointRecord(e){if(!e||typeof e!="object")return{};const t={};for(const[n,o]of Object.entries(e)){if(!o||typeof o!="object")continue;const r=o,i=Number(r.x),a=Number(r.y);!Number.isFinite(i)||!Number.isFinite(a)||(t[n]={x:i,y:a})}return t}hashId(e){let t=2166136261;for(let n=0;n<e.length;n+=1)t^=e.charCodeAt(n),t+=(t<<1)+(t<<4)+(t<<7)+(t<<8)+(t<<24);return t>>>0}buildSortedAdjacency(e,t){const n=new Map;for(const o of e){const r=t.get(o);if(!r||r.size===0){n.set(o,[]);continue}n.set(o,[...r].sort((i,a)=>i.localeCompare(a)))}return n}computeConnectedComponents(e,t){const n=new Set,o=[],r=[...e].sort((i,a)=>i.localeCompare(a));for(const i of r){if(n.has(i))continue;const a=[i],c=[];for(n.add(i);a.length>0;){const d=a.shift();c.push(d);const l=t.get(d);if(!(!l||l.length===0))for(const u of l)n.has(u)||(n.add(u),a.push(u))}c.sort((d,l)=>d.localeCompare(l)),o.push({nodeIds:c})}return o.sort((i,a)=>a.nodeIds.length-i.nodeIds.length||i.nodeIds[0].localeCompare(a.nodeIds[0])),o}buildComponentId(e){const t=e.slice(0,8).join(",");return`component:${e.length}:${this.hashId(t).toString(36)}`}assignStableComponentIds(e,t){const n=t.components;if(n.length===0)return e.map(i=>({componentId:this.buildComponentId(i.nodeIds),nodeIds:i.nodeIds}));const o=new Set,r=e.map(i=>{const a=new Set(i.nodeIds);let c=null,d=0,l=-1;for(const u of n){if(o.has(u.componentId))continue;let f=0;for(const h of a)u.members.has(h)&&(f+=1);if(f===0)continue;const y=f/Math.max(1,Math.max(a.size,u.members.size));(f>d||f===d&&y>l||f===d&&y===l&&c&&u.componentId.localeCompare(c.componentId)<0)&&(c=u,d=f,l=y)}return c?(o.add(c.componentId),{componentId:c.componentId,nodeIds:i.nodeIds}):{componentId:this.buildComponentId(i.nodeIds),nodeIds:i.nodeIds}});return r.sort((i,a)=>a.nodeIds.length-i.nodeIds.length||i.componentId.localeCompare(a.componentId)),r}resolveComponentAnchor(e,t,n){const o=n.anchors[e];if(o)return o;const r=18+Math.sqrt(Math.max(t,1))*12,a=this.hashId(e)%1e3*ze;return{x:Math.cos(a)*r,y:Math.sin(a)*r}}seedPositions(e,t,n,o){const r=new Map,i=Math.max(5,Math.sqrt(e.length)*3);for(let a=0;a<e.length;a+=1){const c=e[a],d=o.nodePositions[c];if(d){r.set(c,d);continue}const l=this.hashId(`${t}:${c}`),u=l%360/360*be,f=(a/Math.max(e.length,1)*be+u)%be,y=i*(.2+(l>>>9)%1e3/1e3*.8);r.set(c,{x:n.x+Math.cos(f)*y,y:n.y+Math.sin(f)*y})}return r}solveComponentPositions(e,t,n,o,r){const i=e.length,a=new Float32Array(i),c=new Float32Array(i),d=new Float32Array(i),l=new Float32Array(i),u=new Map;for(let M=0;M<i;M++){const N=e[M],R=o.get(N)??n;a[M]=R.x,c[M]=R.y,u.set(N,M)}const f=[];for(let M=0;M<i;M++){const N=e[M],R=t.get(N);if(R)for(const b of R){const E=u.get(b);E!==void 0&&M<E&&f.push(M,E)}}const y=Math.floor(de(r.strategyConfig,"iterations",150,20,500)),h=de(r.strategyConfig,"repulsionStrength",100,10,2e3),m=de(r.strategyConfig,"attractionStrength",.05,.001,.5),p=de(r.strategyConfig,"gravityStrength",.05,.001,.5);let g=1;const _=1-Math.pow(.001,1/Math.max(y,1)),I=.6;for(let M=0;M<y;M++){for(let N=0;N<i;N++)for(let R=N+1;R<i;R++){let b=a[N]-a[R],E=c[N]-c[R],v=b*b+E*E;v===0&&(b=(N*17+R*31)%71*.01-.35,E=(N*23+R*47)%71*.01-.35,v=b*b+E*E),v<1&&(v=1);const w=h*g/v,F=b*w,S=E*w;d[N]+=F,l[N]+=S,d[R]-=F,l[R]-=S}for(let N=0;N<f.length;N+=2){const R=f[N],b=f[N+1],E=a[R]-a[b],v=c[R]-c[b],w=m*g,F=E*w,S=v*w;d[R]-=F,l[R]-=S,d[b]+=F,l[b]+=S}for(let N=0;N<i;N++){const R=n.x-a[N],b=n.y-c[N];d[N]+=R*p*g,l[N]+=b*p*g,d[N]*=I,l[N]*=I,a[N]+=d[N],c[N]+=l[N]}g*=1-_}const P=new Map;for(let M=0;M<i;M++)P.set(e[M],{x:a[M],y:c[M]});return P}}const rn={strategy:"fa2line",label:"FA2 Line",fields:[{key:"iterations",label:"Iterations",min:20,max:500,step:10},{key:"attractionStrength",label:"Attraction",min:.001,max:.5,step:.001},{key:"repulsionStrength",label:"Repulsion",min:10,max:2e3,step:10},{key:"gravityStrength",label:"Gravity",min:.001,max:.5,step:.001}],createInitialConfig:()=>({iterations:150,attractionStrength:.05,repulsionStrength:100,gravityStrength:.05}),summarizeConfig:s=>`iter=${Number(s.iterations??150)}`,createAlgorithm:()=>new ts},fe=Math.PI*2,gt=Math.PI*(3-Math.sqrt(5)),ue=1e-9,an=1048576,ns=2097153,ye=(s,e)=>s<e?-1:s>e?1:0,st=(s,e,t)=>Math.max(e,Math.min(t,s));class xt{run(e){const t=de(e.strategyConfig,"quality",1,.5,1.5),n=de(e.strategyConfig,"stability",.8,0,.95),o=de(e.strategyConfig,"nodeSpacing",8,4,20),r=[...e.nodeIds].sort(ye),i=new Map;for(const x of r)i.set(x,this.hashId(x));const a=this.readSnapshot(e.previousState),c=this.indexSnapshot(a),d=this.computeConnectedComponents(r,e.adjacencyByNodeId),l=this.assignStableComponentIds(d,c),u=[];for(const x of l){const _=this.detectCommunitiesLabelPropagation({componentId:x.componentId,nodeIds:x.nodeIds,adjacencyByNodeId:e.adjacencyByNodeId,previousIndex:c}),P=this.assignStableCommunityIds(x.componentId,_,c).map(M=>({communityId:M.communityId,componentId:x.componentId,nodeIds:M.nodeIds,radius:this.computeCommunityRadius(M.nodeIds.length,o),anchorX:0,anchorY:0}));P.sort((M,N)=>N.nodeIds.length-M.nodeIds.length||ye(M.communityId,N.communityId)),u.push({componentId:x.componentId,nodeIds:x.nodeIds,communities:P,radius:this.computeComponentRadius(P,o),anchorX:0,anchorY:0})}u.sort((x,_)=>_.nodeIds.length-x.nodeIds.length||ye(x.componentId,_.componentId)),this.placeComponentAnchors(u,c,o);for(const x of u)this.placeCommunityAnchors(x,c,o);const f=Object.create(null),y=new Map;for(const x of u)for(const _ of x.communities){const{nodeIds:I,x:P,y:M}=this.layoutNodesInCommunity({communityId:_.communityId,componentId:x.componentId,nodeIds:_.nodeIds,anchorX:_.anchorX,anchorY:_.anchorY,communityRadius:_.radius,nodeSpacing:o,stability:n,quality:t,strategyConfig:e.strategyConfig,adjacencyByNodeId:e.adjacencyByNodeId,nodeHashById:i,previousIndex:c});for(let N=0;N<I.length;N++)f[I[N]]={x:P[N],y:M[N]},y.set(I[N],{componentId:x.componentId,communityId:_.communityId,anchorX:_.anchorX,anchorY:_.anchorY})}const h=[],m=[],p={version:2,components:[],communities:[],nodePositions:f};for(const x of u){h.push({componentId:x.componentId,nodeIds:x.nodeIds,anchorX:x.anchorX,anchorY:x.anchorY}),p.components.push({componentId:x.componentId,nodeIds:x.nodeIds,anchorX:x.anchorX,anchorY:x.anchorY,radius:x.radius});for(const _ of x.communities)m.push({communityId:_.communityId,componentId:x.componentId,nodeIds:_.nodeIds,anchorX:_.anchorX,anchorY:_.anchorY}),p.communities.push({communityId:_.communityId,componentId:x.componentId,nodeIds:_.nodeIds,anchorX:_.anchorX,anchorY:_.anchorY,radius:_.radius})}const g=[];for(const x of r){const _=f[x]??c.nodePositions[x]??{x:0,y:0},I=y.get(x),P=(I==null?void 0:I.componentId)??c.componentByNodeId.get(x)??"component:unknown",M=(I==null?void 0:I.communityId)??c.communityByNodeId.get(x)??`${P}:community:unknown`,N=(I==null?void 0:I.anchorX)??_.x,R=(I==null?void 0:I.anchorY)??_.y;let b=0,E=0,v=0;const w=e.adjacencyByNodeId.get(x);if(w)for(const F of w){const S=f[F];S&&(b+=S.x,E+=S.y,v++)}v===0?(b=_.x,E=_.y):(b/=v,E/=v),g.push({nodeId:x,componentId:P,communityId:M,targetX:_.x,targetY:_.y,neighborX:b,neighborY:E,anchorX:N,anchorY:R})}return{layout:{components:h,communities:m,nodeTargets:g},metadata:{state:p}}}readSnapshot(e){if(!e||typeof e!="object")return;const t=e;if(!Array.isArray(t.components)||!Array.isArray(t.communities)||!t.nodePositions||typeof t.nodePositions!="object")return;const n=[];for(const r of t.components){if(!r||typeof r!="object")continue;const i=r,a=typeof i.componentId=="string"?i.componentId:null,c=Number(i.anchorX),d=Number(i.anchorY);if(!a||!Number.isFinite(c)||!Number.isFinite(d))continue;const l=this.readStringArray(i.nodeIds)??this.readStringArray(i.members)??[],u=i.radius==null?void 0:Number(i.radius);n.push({componentId:a,nodeIds:l,anchorX:c,anchorY:d,radius:Number.isFinite(u??NaN)?u:void 0})}const o=[];for(const r of t.communities){if(!r||typeof r!="object")continue;const i=r,a=typeof i.communityId=="string"?i.communityId:null,c=typeof i.componentId=="string"?i.componentId:null,d=Number(i.anchorX),l=Number(i.anchorY);if(!a||!c||!Number.isFinite(d)||!Number.isFinite(l))continue;const u=this.readStringArray(i.nodeIds)??this.readStringArray(i.members)??[],f=i.radius==null?void 0:Number(i.radius);o.push({communityId:a,componentId:c,nodeIds:u,anchorX:d,anchorY:l,radius:Number.isFinite(f??NaN)?f:void 0})}return{version:2,components:n,communities:o,nodePositions:this.toPointRecord(t.nodePositions)}}readStringArray(e){if(!e)return null;const t=[];if(Array.isArray(e)){for(const n of e)typeof n=="string"&&t.push(n);return t}if(e instanceof Set){for(const n of e)typeof n=="string"&&t.push(n);return t}return null}toPointRecord(e){if(!e||typeof e!="object")return Object.create(null);const t=Object.create(null);for(const[n,o]of Object.entries(e)){if(!o||typeof o!="object")continue;const r=o,i=Number(r.x),a=Number(r.y);!Number.isFinite(i)||!Number.isFinite(a)||(t[n]={x:i,y:a})}return t}indexSnapshot(e){const t=new Map,n=new Map,o=new Map,r=new Map,i=new Map,a=new Map,c=new Map;if(!e)return{componentByNodeId:t,communityByNodeId:n,componentSizeById:o,communitySizeById:r,componentAnchorById:i,communityAnchorById:a,communityComponentById:c,nodePositions:Object.create(null)};for(const d of e.components){o.set(d.componentId,d.nodeIds.length),i.set(d.componentId,{x:d.anchorX,y:d.anchorY});for(const l of d.nodeIds)t.set(l,d.componentId)}for(const d of e.communities){r.set(d.communityId,d.nodeIds.length),a.set(d.communityId,{x:d.anchorX,y:d.anchorY}),c.set(d.communityId,d.componentId);for(const l of d.nodeIds)n.set(l,d.communityId)}return{componentByNodeId:t,communityByNodeId:n,componentSizeById:o,communitySizeById:r,componentAnchorById:i,communityAnchorById:a,communityComponentById:c,nodePositions:e.nodePositions??Object.create(null)}}hashId(e){let t=2166136261;for(let n=0;n<e.length;n++)t^=e.charCodeAt(n),t=Math.imul(t,16777619);return t>>>0}buildComponentId(e){return`component:${e.length}:${this.hashId(e.slice(0,10).join(",")).toString(36)}`}buildCommunityId(e,t){return`${e}:community:${t.length}:${this.hashId(t.slice(0,10).join(",")).toString(36)}`}computeConnectedComponents(e,t){const n=new Set,o=[];for(const r of e){if(n.has(r))continue;const i=[r];n.add(r);let a=0;const c=[];for(;a<i.length;){const d=i[a++];c.push(d);const l=t.get(d);if(l)for(const u of l)n.has(u)||(n.add(u),i.push(u))}c.sort(ye),o.push(c)}return o.sort((r,i)=>i.length-r.length||ye(r[0]??"",i[0]??"")),o}assignStableComponentIds(e,t){const n=new Set,o=[];for(const r of e){const i=new Map;for(const u of r){const f=t.componentByNodeId.get(u);f&&i.set(f,(i.get(f)??0)+1)}let a=null,c=0,d=-1;for(const[u,f]of i){if(n.has(u))continue;const y=f/Math.max(1,Math.max(t.componentSizeById.get(u)??0,r.length));(f>c||f===c&&y>d||f===c&&y===d&&a!==null&&ye(u,a)<0)&&(a=u,c=f,d=y)}const l=a??this.buildComponentId(r);a&&n.add(a),o.push({componentId:l,nodeIds:r})}return o.sort((r,i)=>i.nodeIds.length-r.nodeIds.length||ye(r.componentId,i.componentId)),o}detectCommunitiesLabelPropagation(e){const{componentId:t,nodeIds:n,adjacencyByNodeId:o,previousIndex:r}=e;if(n.length<=1)return n.length===1?[n]:[];const i=[...n].sort(ye),a=new Map;for(let y=0;y<i.length;y++)a.set(i[y],y);const c=new Map;for(const y of i){const h=r.communityByNodeId.get(y),m=h?r.communityComponentById.get(h):null;c.set(y,h&&m===t?h:y)}const d=st(Math.ceil(Math.log2(i.length+1))+6,6,18),l=new Map;for(let y=0;y<d;y++){let h=!1;for(const m of i){const p=o.get(m);if(!p||p.size===0)continue;l.clear();for(const I of p){if(!a.has(I))continue;const P=c.get(I)??I;l.set(P,(l.get(P)??0)+1)}const g=c.get(m)??m;l.set(g,(l.get(g)??0)+1.15);let x=g,_=-1/0;for(const[I,P]of l)(P>_||P===_&&ye(I,x)<0)&&(x=I,_=P);x!==g&&(c.set(m,x),h=!0)}if(!h)break}const u=new Map;for(const y of i){const h=c.get(y)??y,m=u.get(h);m?m.push(y):u.set(h,[y])}const f=[...u.values()];for(const y of f)y.sort(ye);return f.sort((y,h)=>h.length-y.length||ye(y[0]??"",h[0]??"")),f}assignStableCommunityIds(e,t,n){const o=new Set,r=[];for(const i of t){const a=new Map;for(const f of i){const y=n.communityByNodeId.get(f);!y||n.communityComponentById.get(y)!==e||a.set(y,(a.get(y)??0)+1)}let c=null,d=0,l=-1;for(const[f,y]of a){if(o.has(f))continue;const h=y/Math.max(1,Math.max(n.communitySizeById.get(f)??0,i.length));(y>d||y===d&&h>l||y===d&&h===l&&c!==null&&ye(f,c)<0)&&(c=f,d=y,l=h)}const u=c??this.buildCommunityId(e,i);c&&o.add(c),r.push({communityId:u,nodeIds:i})}return r.sort((i,a)=>a.nodeIds.length-i.nodeIds.length||ye(i.communityId,a.communityId)),r}computeCommunityRadius(e,t){return t*(2.5+1.3*Math.sqrt(Math.max(1,e)))}computeComponentRadius(e,t){if(e.length===0)return t*10;let n=0;for(const o of e)n+=o.radius*o.radius;return Math.sqrt(n*1.3)+t*5}placeComponentAnchors(e,t,n){const o=e.length;if(o===0)return;if(o===1){const u=t.componentAnchorById.get(e[0].componentId);e[0].anchorX=(u==null?void 0:u.x)??0,e[0].anchorY=(u==null?void 0:u.y)??0;return}const r=new Float64Array(o),i=new Float64Array(o);for(let u=0;u<o;u++){const f=t.componentAnchorById.get(e[u].componentId);if(f)r[u]=f.x,i[u]=f.y;else{const y=u*gt,h=n*14*Math.sqrt(u+1);r[u]=Math.cos(y)*h,i[u]=Math.sin(y)*h}}const a=n*4;for(let u=0;u<80;u++){let f=!1;for(let y=0;y<o;y++)for(let h=y+1;h<o;h++){const m=r[h]-r[y],p=i[h]-i[y],g=m*m+p*p,x=e[y].radius+e[h].radius+a;if(g>=x*x)continue;f=!0;const _=Math.sqrt(g)||ue,I=(x-_)*.55,P=m/_,M=p/_,N=e[y].nodeIds.length,R=e[h].nodeIds.length,b=N+R;r[y]-=P*I*R/b,i[y]-=M*I*R/b,r[h]+=P*I*N/b,i[h]+=M*I*N/b}if(!f)break}let c=0,d=0,l=0;for(let u=0;u<o;u++){const f=t.componentAnchorById.get(e[u].componentId);f&&(c+=f.x-r[u],d+=f.y-i[u],l++)}if(l>0){const u=c/l,f=d/l;for(let y=0;y<o;y++)r[y]+=u,i[y]+=f}for(let u=0;u<o;u++)e[u].anchorX=r[u],e[u].anchorY=i[u]}placeCommunityAnchors(e,t,n){const o=e.communities;if(o.length===0)return;if(o.length===1){o[0].anchorX=e.anchorX,o[0].anchorY=e.anchorY;return}const r=o.length,i=new Float64Array(r),a=new Float64Array(r),c=t.componentAnchorById.get(e.componentId),d=c?e.anchorX-c.x:0,l=c?e.anchorY-c.y:0;for(let f=0;f<r;f++){const y=t.communityAnchorById.get(o[f].communityId);if(y)i[f]=y.x+d,a[f]=y.y+l;else{const h=f*gt,m=Math.max(o[0].radius*.6,n*5)*Math.sqrt(f+1);i[f]=e.anchorX+Math.cos(h)*m,a[f]=e.anchorY+Math.sin(h)*m}}const u=n*2;for(let f=0;f<80;f++){let y=!1;for(let h=0;h<r;h++)for(let m=h+1;m<r;m++){const p=i[m]-i[h],g=a[m]-a[h],x=p*p+g*g,_=o[h].radius+o[m].radius+u;if(x>=_*_)continue;y=!0;const I=Math.sqrt(x)||ue,P=(_-I)*.55,M=p/I,N=g/I,R=o[h].nodeIds.length,b=o[m].nodeIds.length,E=R+b;i[h]-=M*P*b/E,a[h]-=N*P*b/E,i[m]+=M*P*R/E,a[m]+=N*P*R/E}if(!y)break}for(let f=0;f<r;f++)o[f].anchorX=i[f],o[f].anchorY=a[f]}gridPush(e,t,n){let o=e.buckets.get(t);o||(o=e.pool.pop()??[],e.buckets.set(t,o),e.usedKeys.push(t)),o.push(n)}gridClear(e){for(const t of e.usedKeys){const n=e.buckets.get(t);n&&(n.length=0,e.pool.push(n),e.buckets.delete(t))}e.usedKeys.length=0}gridKey(e,t,n){const o=Math.floor(e/n),r=Math.floor(t/n);return(o+an)*ns+(r+an)}clampToContainment(e,t,n,o,r,i){for(let a=0;a<i;a++){const c=e[a]-n,d=t[a]-o,l=Math.sqrt(c*c+d*d);if(l>r){const u=r/l;e[a]=n+c*u,t[a]=o+d*u}}}}const cn=1,dn=.8,ss=8,Pt=.8,Bt=2;function ot(s,e,t,n){return{x1:s,y1:e,x2:t,y2:n,totalMass:0,comX:0,comY:0,nodeIdx:-2,nodeX:0,nodeY:0,nodeMass:0,nw:null,ne:null,sw:null,se:null}}function rt(s,e,t,n,o){if(s.nodeIdx===-2){s.nodeIdx=e,s.nodeX=t,s.nodeY=n,s.nodeMass=o,s.comX=t,s.comY=n,s.totalMass=o;return}const r=s.totalMass+o;if(s.comX=(s.comX*s.totalMass+t*o)/r,s.comY=(s.comY*s.totalMass+n*o)/r,s.totalMass=r,s.nodeIdx>=0){const i=s.nodeIdx,a=s.nodeX,c=s.nodeY,d=s.nodeMass;s.nodeIdx=-1,ln(s,i,a,c,d)}ln(s,e,t,n,o)}function ln(s,e,t,n,o){const r=(s.x1+s.x2)*.5,i=(s.y1+s.y2)*.5,a=t<r,c=n<i;a&&c?(s.nw||(s.nw=ot(s.x1,s.y1,r,i)),rt(s.nw,e,t,n,o)):!a&&c?(s.ne||(s.ne=ot(r,s.y1,s.x2,i)),rt(s.ne,e,t,n,o)):a&&!c?(s.sw||(s.sw=ot(s.x1,i,r,s.y2)),rt(s.sw,e,t,n,o)):(s.se||(s.se=ot(r,i,s.x2,s.y2)),rt(s.se,e,t,n,o))}function it(s,e,t,n,o,r,i,a,c){if(s.nodeIdx===-2||s.totalMass===0||s.nodeIdx===e)return;const d=t-s.comX,l=n-s.comY,u=d*d+l*l,f=Math.sqrt(u)||ue,y=s.x2-s.x1;if(!(t>=s.x1&&t<s.x2&&n>=s.y1&&n<s.y2)&&(s.nodeIdx>=0||y/f<r)){const m=i*o*s.totalMass/f;a[e]+=d/f*m,c[e]+=l/f*m;return}s.nw&&it(s.nw,e,t,n,o,r,i,a,c),s.ne&&it(s.ne,e,t,n,o,r,i,a,c),s.sw&&it(s.sw,e,t,n,o,r,i,a,c),s.se&&it(s.se,e,t,n,o,r,i,a,c)}function os(s,e,t,n){if(n===0)return null;let o=1/0,r=1/0,i=-1/0,a=-1/0;for(let l=0;l<n;l++)s[l]<o&&(o=s[l]),e[l]<r&&(r=e[l]),s[l]>i&&(i=s[l]),e[l]>a&&(a=e[l]);const c=1+(i-o+a-r)*.01,d=ot(o-c,r-c,i+c,a+c);for(let l=0;l<n;l++)rt(d,l,s[l],e[l],t[l]);return d}class rs extends xt{constructor(){super(...arguments);W(this,"strategy","bh-fa2")}layoutNodesInCommunity(t){const{communityId:n,nodeIds:o,anchorX:r,anchorY:i,communityRadius:a,nodeSpacing:c,stability:d,quality:l,strategyConfig:u,adjacencyByNodeId:f,nodeHashById:y,previousIndex:h}=t,m=o.length,p=new Float64Array(m),g=new Float64Array(m);if(m===0)return{nodeIds:o,x:p,y:g};const x=de(u,"gravity",Pt,.1,3),_=de(u,"scalingRatio",Bt,.5,5),I=1.2,P=new Map;for(let L=0;L<m;L++)P.set(o[L],L);const M=h.communityAnchorById.get(n),N=M?r-M.x:0,R=M?i-M.y:0,b=a*1.05,E=this.hashId(n)%1e4/1e4*fe;for(let L=0;L<m;L++){const H=h.nodePositions[o[L]];if(H){p[L]=H.x+N,g[L]=H.y+R;const oe=p[L]-r,se=g[L]-i,ce=Math.sqrt(oe*oe+se*se);ce>b&&(p[L]=r+oe*b/ce,g[L]=i+se*b/ce)}else{const oe=(L+.5)/Math.max(1,m),se=Math.sqrt(oe)*Math.max(c*3,a-c*2),ce=y.get(o[L])??0,me=L*gt+E+(ce%1024/1024-.5)*.05;p[L]=r+Math.cos(me)*se,g[L]=i+Math.sin(me)*se}}const v=new Float64Array(m);for(let L=0;L<m;L++){const H=f.get(o[L]);if(H)for(const oe of H)P.has(oe)&&v[L]++}const w=new Float64Array(m);for(let L=0;L<m;L++)w[L]=v[L]+1;if(!M||m>20){let L=0;for(let H=0;H<m;H++)h.nodePositions[o[H]]||L++;L>m*.4&&this.coarseInit(p,g,o,r,i,a,c,v,f,E)}const F=[],S=[];for(let L=0;L<m;L++){const H=f.get(o[L]);if(H)for(const oe of H){const se=P.get(oe);se!=null&&se>L&&(F.push(L),S.push(se))}}const C=st(Math.round(30*l*(m<=80?1.4:m<=300?1.1:m<=1200?.85:.55)),6,60),T=new Float64Array(m),O=new Float64Array(m),Y=new Float64Array(m),X=new Float64Array(m),q=new Float64Array(m),Q=new Float64Array(m).fill(c*.8),J=a*.3;for(let L=0;L<C;L++){T.fill(0),O.fill(0);const oe=1-L/Math.max(1,C-1)*.7,se=os(p,g,w,m);if(se)for(let k=0;k<m;k++)it(se,k,p[k],g[k],w[k],I,_,T,O);for(let k=0;k<F.length;k++){const $=F[k],D=S[k];let te=p[D]-p[$],ae=g[D]-g[$],ie=te*te+ae*ae;if(ie<ue){const Ye=($*997+D*991+L*37)%360*(fe/360);te=Math.cos(Ye),ae=Math.sin(Ye),ie=1}const pe=Math.sqrt(ie),Me=Math.log(1+pe)/_,Ee=te/pe,pt=ae/pe,De=Me/(v[$]+1),Ue=Me/(v[D]+1);T[$]+=Ee*De*w[$],O[$]+=pt*De*w[$],T[D]-=Ee*Ue*w[D],O[D]-=pt*Ue*w[D]}for(let k=0;k<m;k++){const $=r-p[k],D=i-g[k],te=Math.sqrt($*$+D*D)||ue,ae=x*w[k]*te;T[k]+=$/te*ae,O[k]+=D/te*ae}let ce=0,me=0;for(let k=0;k<m;k++){const $=T[k]-Y[k],D=O[k]-X[k];q[k]=Math.sqrt($*$+D*D);const te=T[k]+Y[k],ae=O[k]+X[k];ce+=w[k]*q[k],me+=w[k]*Math.sqrt(te*te+ae*ae)*.5}const B=ce>ue?me/ce:1,A=st(.1*B*oe,.005,c*1.2);for(let k=0;k<m;k++){Q[k]=Math.min(st(Q[k]*(1+.2*(q[k]<.1?1:-1)),.005,J),A/(1+A*q[k]*.15));const $=Math.sqrt(T[k]*T[k]+O[k]*O[k])||ue,D=Math.min(Q[k],J/$);p[k]+=T[k]/$*$*D,g[k]+=O[k]/$*$*D,Y[k]=T[k],X[k]=O[k]}this.clampToContainment(p,g,r,i,b,m)}if(d>0){for(let L=0;L<m;L++){const H=h.nodePositions[o[L]];if(!H)continue;const oe=H.x+N,se=H.y+R;p[L]=oe+(p[L]-oe)*(1-d),g[L]=se+(g[L]-se)*(1-d)}this.clampToContainment(p,g,r,i,b,m)}return{nodeIds:o,x:p,y:g}}coarseInit(t,n,o,r,i,a,c,d,l,u){const f=o.length;if(f<=3)return;const y=Array.from({length:f},(_,I)=>I).sort((_,I)=>d[I]-d[_]),h=Math.max(1,Math.round(f*.12)),m=Math.max(h+1,Math.round(f*.45)),p=c*1.5,g=Math.max(c*3,a*.38),x=Math.max(c*5,a*.78);for(let _=0;_<f;_++){const I=y[_];let P;_<h?P=p:_<m?P=g:P=x,l.get(o[I]);const M=u+_/f*fe+(_<h?0:I*gt);t[I]=r+Math.cos(M)*P,n[I]=i+Math.sin(M)*P}}}const is={strategy:"bh-fa2",label:"Barnes-Hut FA2",fields:[{key:"quality",label:"Quality",min:.5,max:1.5,step:.05},{key:"stability",label:"Stability",min:0,max:.95,step:.05},{key:"nodeSpacing",label:"Node Spacing",min:4,max:20,step:1},{key:"gravity",label:"Gravity",min:.1,max:3,step:.1},{key:"scalingRatio",label:"Scaling Ratio",min:.5,max:5,step:.1}],createInitialConfig:()=>({quality:cn,stability:dn,nodeSpacing:ss,gravity:Pt,scalingRatio:Bt}),summarizeConfig:s=>`q=${Number(s.quality??cn).toFixed(2)} stab=${Number(s.stability??dn).toFixed(2)} g=${Number(s.gravity??Pt).toFixed(1)} k=${Number(s.scalingRatio??Bt).toFixed(1)}`,createAlgorithm:()=>new rs},at=Math.PI*2,jt=Math.PI*(3-Math.sqrt(5)),as=4;class cs{constructor(){W(this,"strategy","hybrid-backbone")}run(e){const t=Math.floor(de(e.strategyConfig,"refinementIterations",as,2,20)),n=de(e.strategyConfig,"communityPlacementScale",1,.4,2.4),o=this.buildSortedAdjacency(e.nodeIds,e.adjacencyByNodeId),r=this.computeConnectedComponents(e.nodeIds,o),i=this.asLayoutSnapshot(e.previousState),a=this.assignStableComponentIds(r,i),c=this.resolveComponentAnchors(a,i,n),d=[],l=[],u=[],f={components:[],communities:[],nodePositions:{}};for(const y of a){const h=c.get(y.componentId)??{x:0,y:0};let m=0,p=0;if(i){for(const R of i.components)if(R.componentId===y.componentId){m=h.x-R.anchorX,p=h.y-R.anchorY;break}}d.push({componentId:y.componentId,nodeIds:y.nodeIds,anchorX:h.x,anchorY:h.y}),f.components.push({componentId:y.componentId,members:new Set(y.nodeIds),anchorX:h.x,anchorY:h.y});const g=this.computeCommunities(y.nodeIds,o,i),x=this.assignStableCommunityIds(y.componentId,g,i),_=new Map,I=[],P=[];for(const R of x){const b=R.nodeIds;P.push(7+Math.sqrt(b.length)*3.6)}const N=(12+(P.length>0?Math.max(...P):0)*1.4+Math.sqrt(x.length)*7)*n;for(let R=0;R<x.length;R+=1){const b=x[R],E=b.nodeIds,v=b.communityId,w=this.hashId(`${v}:angle`)%360,F=x.length<=1?0:(R*53+w)%360/360*at,S=this.resolvePreviousCommunityAnchor(i,v),C=h.x+Math.cos(F)*N,T=h.y+Math.sin(F)*N;let O=C,Y=T;if(S){const Q=S.x+m,J=S.y+p;O=Q+(C-Q)*.15,Y=J+(T-J)*.15}const X={x:O,y:Y};_.set(v,X);const q={communityId:v,componentId:y.componentId,nodeIds:E,anchorX:X.x,anchorY:X.y};I.push(q),l.push(q),f.communities.push({communityId:v,componentId:y.componentId,members:new Set(E),anchorX:X.x,anchorY:X.y})}for(const R of I){const b=_.get(R.communityId),E=new Map;for(const w of R.nodeIds){const F=i==null?void 0:i.nodePositions[w];if(F){let S=0,C=0,T=!1;if(i){for(const O of i.communities)if(O.members.has(w)){S=O.anchorX,C=O.anchorY,T=!0;break}}T?E.set(w,{x:b.x+(F.x-S),y:b.y+(F.y-C)}):E.set(w,F)}}const v=this.refineCommunityTargets({communityNodeIds:R.nodeIds,sortedAdjacencyByNodeId:o,initialPositions:E,anchorX:b.x,anchorY:b.y,componentId:y.componentId,communityId:R.communityId,refinementIterations:Math.max(2,t)});for(const w of v)u.push(w),f.nodePositions[w.nodeId]={x:w.targetX,y:w.targetY}}}return u.sort((y,h)=>y.nodeId.localeCompare(h.nodeId)),{layout:{components:d,communities:l,nodeTargets:u},metadata:{state:f}}}asLayoutSnapshot(e){if(!e||typeof e!="object")return;const t=e;if(!Array.isArray(t.components))return;const n=[];for(const o of t.components){if(!o||typeof o!="object")continue;const r=o,i=typeof r.componentId=="string"?r.componentId:null,a=Number(r.anchorX),c=Number(r.anchorY);if(!i||!Number.isFinite(a)||!Number.isFinite(c))continue;const d=new Set;if(r.members instanceof Set)for(const l of r.members)typeof l=="string"&&d.add(l);n.push({componentId:i,members:d,anchorX:a,anchorY:c})}return{components:n,communities:this.toCommunitySnapshots(e.communities),nodePositions:this.toPointRecord(e.nodePositions)}}toPointRecord(e){if(!e||typeof e!="object")return{};const t={};for(const[n,o]of Object.entries(e)){if(!o||typeof o!="object")continue;const r=o,i=Number(r.x),a=Number(r.y);!Number.isFinite(i)||!Number.isFinite(a)||(t[n]={x:i,y:a})}return t}toCommunitySnapshots(e){if(!Array.isArray(e))return[];const t=[];for(const n of e){if(!n||typeof n!="object")continue;const o=n;if(typeof o.communityId!="string"||typeof o.componentId!="string")continue;const r=Number(o.anchorX),i=Number(o.anchorY);if(!Number.isFinite(r)||!Number.isFinite(i))continue;const a=new Set;if(Array.isArray(o.members))for(const c of o.members)typeof c=="string"&&a.add(c);else if(o.members instanceof Set)for(const c of o.members)typeof c=="string"&&a.add(c);t.push({communityId:o.communityId,componentId:o.componentId,members:a,anchorX:r,anchorY:i})}return t}hashId(e){let t=2166136261;for(let n=0;n<e.length;n+=1)t^=e.charCodeAt(n),t+=(t<<1)+(t<<4)+(t<<7)+(t<<8)+(t<<24);return t>>>0}buildSortedAdjacency(e,t){const n=new Map;for(const o of e){const r=t.get(o);if(!r||r.size===0){n.set(o,[]);continue}n.set(o,[...r].sort((i,a)=>i.localeCompare(a)))}return n}computeConnectedComponents(e,t){const n=new Set,o=[],r=[...e].sort((i,a)=>i.localeCompare(a));for(const i of r){if(n.has(i))continue;const a=[i],c=[];for(n.add(i);a.length>0;){const d=a.shift();c.push(d);const l=t.get(d);if(!(!l||l.length===0))for(const u of l)n.has(u)||(n.add(u),a.push(u))}c.sort((d,l)=>d.localeCompare(l)),o.push({nodeIds:c})}return o.sort((i,a)=>a.nodeIds.length-i.nodeIds.length||i.nodeIds[0].localeCompare(a.nodeIds[0])),o}computeCommunities(e,t,n){const o=new Map,r=[...e].sort((d,l)=>d.localeCompare(l));if(n){const d=new Map;for(const l of n.communities)for(const u of l.members)d.set(u,l.communityId);for(const l of r)o.set(l,d.get(l)??l)}else for(const d of r)o.set(d,d);const i=Math.max(2,Math.min(10,Math.ceil(Math.log2(e.length+1))+2));for(let d=0;d<i;d+=1){let l=!1;for(const u of r){const f=t.get(u);if(!f||f.length===0)continue;const y=new Map;for(const p of f){const g=o.get(p)??p;y.set(g,(y.get(g)??0)+1)}let h=o.get(u)??u,m=-1;for(const[p,g]of y.entries())(g>m||g===m&&p.localeCompare(h)<0)&&(h=p,m=g);h!==o.get(u)&&(o.set(u,h),l=!0)}if(!l)break}const a=new Map;for(const d of r){const l=o.get(d)??d,u=a.get(l)??[];u.push(d),a.set(l,u)}const c=[...a.values()].map(d=>d.sort((l,u)=>l.localeCompare(u)));return c.sort((d,l)=>l.length-d.length||d[0].localeCompare(l[0])),c}buildComponentId(e){const t=e.slice(0,8).join(",");return`component:${e.length}:${this.hashId(t).toString(36)}`}assignStableComponentIds(e,t){const n=(t==null?void 0:t.components)??[],o=new Set,r=e.map(i=>{const a=new Set(i.nodeIds);let c=null,d=0,l=-1;for(const f of n){if(o.has(f.componentId))continue;let y=0;for(const m of a)f.members.has(m)&&(y+=1);if(y===0)continue;const h=y/Math.max(1,Math.max(a.size,f.members.size));(y>d||y===d&&h>l||y===d&&h===l&&c&&f.componentId.localeCompare(c.componentId)<0)&&(c=f,d=y,l=h)}const u=c?c.componentId:this.buildComponentId(i.nodeIds);return c&&o.add(c.componentId),{componentId:u,nodeIds:i.nodeIds,weight:i.nodeIds.length}});return r.sort((i,a)=>a.weight-i.weight||i.componentId.localeCompare(a.componentId)),r}assignStableCommunityIds(e,t,n){const o=((n==null?void 0:n.communities)??[]).filter(i=>i.componentId===e),r=new Set;return t.map((i,a)=>{const c=new Set(i);let d=null,l=0,u=-1;for(const y of o){if(r.has(y.communityId))continue;let h=0;for(const p of c)y.members.has(p)&&(h+=1);if(h===0)continue;const m=h/Math.max(1,Math.max(c.size,y.members.size));(h>l||h===l&&m>u||h===l&&m===u&&d&&y.communityId.localeCompare(d.communityId)<0)&&(d=y,l=h,u=m)}if(d)return r.add(d.communityId),{communityId:d.communityId,nodeIds:i};const f=i.slice(0,6).join(",");return{communityId:`${e}:community:${a}:${this.hashId(f).toString(36)}`,nodeIds:i}}).sort((i,a)=>a.nodeIds.length-i.nodeIds.length||i.communityId.localeCompare(a.communityId))}resolvePreviousCommunityAnchor(e,t){if(!e)return null;for(const n of e.communities)if(n.communityId===t)return{x:n.anchorX,y:n.anchorY};return null}componentRadius(e){return 30+Math.sqrt(Math.max(e,1))*10}isAnchorPlacementFree(e,t,n,o){for(const r of e){const i=t-r.x,a=n-r.y,c=r.radius+o+10;if(i*i+a*a<c*c)return!1}return!0}placeAnchorNearPreferred(e,t,n,o){if(this.isAnchorPlacementFree(n,e.x,e.y,t))return e;const r=18;for(let c=1;c<=28;c+=1){const d=c*(t*.9+8);for(let l=0;l<r;l+=1){const u=(l+o)/r*at,f=e.x+Math.cos(u)*d,y=e.y+Math.sin(u)*d;if(this.isAnchorPlacementFree(n,f,y,t))return{x:f,y}}}const i=40+o*11,a=o*jt;return{x:e.x+Math.cos(a)*i,y:e.y+Math.sin(a)*i}}resolveComponentAnchors(e,t,n){const o=new Map,r=new Set,i=[],a=[...e].sort((c,d)=>d.weight-c.weight||c.componentId.localeCompare(d.componentId));for(const c of a){const d=this.componentRadius(c.weight)*Math.max(1,n),l=this.hashId(c.componentId)%31;let u={x:0,y:0},f=!1;if(!t||t.components.length===0){const m=24+Math.sqrt(c.weight)*7,p=l*jt;u={x:Math.cos(p)*m,y:Math.sin(p)*m},f=!0}else{const m=new Set(c.nodeIds);let p=null,g=-1,x=-1;for(const _ of t.components){if(r.has(_.componentId))continue;let I=0;for(const M of m)_.members.has(M)&&(I+=1);const P=I/Math.max(1,Math.max(m.size,_.members.size));(I>g||I===g&&P>x||I===g&&P===x&&p!==null&&_.componentId.localeCompare(p.componentId)<0)&&(p=_,g=I,x=P)}p&&g>0&&(u={x:p.anchorX,y:p.anchorY},f=!0,r.add(p.componentId))}if(!f){const m=24+Math.sqrt(c.weight)*7,p=l*jt;u={x:Math.cos(p)*m,y:Math.sin(p)*m}}const y=this.placeAnchorNearPreferred(u,d,i,l),h={x:y.x,y:y.y,radius:d};i.push(h),o.set(c.componentId,h)}return new Map([...o.entries()].map(([c,d])=>[c,{x:d.x,y:d.y}]))}refineCommunityTargets(e){const{communityNodeIds:t,sortedAdjacencyByNodeId:n,initialPositions:o,anchorX:r,anchorY:i,componentId:a,communityId:c,refinementIterations:d}=e,l=[...t].sort((M,N)=>M.localeCompare(N)),u=new Set(l),f=new Map,y=Math.max(8,Math.sqrt(l.length)*3.2);for(let M=0;M<l.length;M+=1){const N=l[M],R=o.get(N);if(R){f.set(N,{x:R.x,y:R.y});continue}const b=this.hashId(`${c}:${N}`),E=b%360/360*at,v=(M/Math.max(l.length,1)*at+E)%at,w=y*(.55+(b>>>8)%1e3/1e3*.7);f.set(N,{x:r+Math.cos(v)*w,y:i+Math.sin(v)*w})}const h=.2,m=.04,p=1.15,g=Math.max(4.2,y*.15),x=Math.max(18,y*1.8),_=Math.max(12,x),I=2.6;for(let M=0;M<d;M+=1){const N=new Map,R=new Map;for(const b of l){const E=f.get(b),v=Math.floor(E.x/_),w=Math.floor(E.y/_),F=`${v}:${w}`,S=R.get(F)??[];S.push(b),R.set(F,S)}for(const b of l){const E=f.get(b),v=n.get(b);let w=0,F=0,S=0;if(v&&v.length>0)for(const q of v){if(!u.has(q))continue;const Q=f.get(q);Q&&(w+=Q.x,F+=Q.y,S+=1)}let C=0,T=0;if(S>0){const q=w/S,Q=F/S;C+=(q-E.x)*h,T+=(Q-E.y)*h}C+=(r-E.x)*m,T+=(i-E.y)*m;const O=Math.floor(E.x/_),Y=Math.floor(E.y/_);for(let q=-1;q<=1;q+=1)for(let Q=-1;Q<=1;Q+=1){const J=`${O+q}:${Y+Q}`,L=R.get(J);if(L)for(const H of L){if(H===b)continue;const oe=f.get(H),se=E.x-oe.x,ce=E.y-oe.y,me=se*se+ce*ce;if(me<=1e-4){const k=this.hashId(b+H)%100/50-1,$=this.hashId(H+b)%100/50-1;C+=k*.5,T+=$*.5;continue}if(me>x*x)continue;const B=Math.sqrt(me),A=(x-B)/x*p;if(C+=se/B*A,T+=ce/B*A,B<I){const k=(I-B)/I;C+=se/B*k*.9,T+=ce/B*k*.9}}}const X=Math.sqrt(C*C+T*T);X>g&&X>0&&(C=C/X*g,T=T/X*g),N.set(b,{x:E.x+C,y:E.y+T})}f.clear();for(const[b,E]of N.entries())f.set(b,E)}const P=[];for(const M of l){const N=f.get(M),R=n.get(M);let b=0,E=0,v=0;if(R&&R.length>0)for(const w of R){if(!u.has(w))continue;const F=f.get(w);F&&(b+=F.x,E+=F.y,v+=1)}v===0?(b=N.x,E=N.y):(b/=v,E/=v),P.push({nodeId:M,componentId:a,communityId:c,targetX:N.x,targetY:N.y,neighborX:b,neighborY:E,anchorX:r,anchorY:i})}return P}}const ds={strategy:"hybrid-backbone",label:"Hybrid Backbone",fields:[{key:"refinementIterations",label:"Refine Iterations",min:2,max:20,step:1},{key:"communityPlacementScale",label:"Community Spread",min:.4,max:2.4,step:.05}],createInitialConfig:()=>({refinementIterations:4,communityPlacementScale:1}),summarizeConfig:s=>{const e=Number(s.refinementIterations??4),t=Number(s.communityPlacementScale??1);return`iter=${e} spread=${t.toFixed(2)}`},createAlgorithm:()=>new cs},un=1,fn=.8,ls=8,Ot=4;class us extends xt{constructor(){super(...arguments);W(this,"strategy","radial-sugiyama")}layoutNodesInCommunity(t){var B;const{communityId:n,nodeIds:o,anchorX:r,anchorY:i,communityRadius:a,nodeSpacing:c,stability:d,quality:l,strategyConfig:u,adjacencyByNodeId:f,nodeHashById:y,previousIndex:h}=t,m=o.length,p=new Float64Array(m),g=new Float64Array(m);if(m===0)return{nodeIds:o,x:p,y:g};if(m===1)return p[0]=r,g[0]=i,{nodeIds:o,x:p,y:g};const x=Math.round(de(u,"sweepPasses",Ot,1,8)*l),_=new Map;for(let A=0;A<m;A++)_.set(o[A],A);let I=0,P=-1;for(let A=0;A<m;A++){let k=0;const $=f.get(o[A]);if($)for(const D of $)_.has(D)&&k++;(k>P||k===P&&ye(o[A],o[I])<0)&&(P=k,I=A)}const M=new Int32Array(m).fill(-1),N=new Int32Array(m).fill(-1),R=new Int32Array(m);M[I]=0,R[0]=I;let b=0,E=1,v=0;for(;b<E;){const A=R[b++],k=M[A],$=f.get(o[A]);if($)for(const D of $){const te=_.get(D);te==null||M[te]!==-1||(M[te]=k+1,N[te]=A,k+1>v&&(v=k+1),R[E++]=te)}}for(let A=0;A<m;A++)M[A]===-1&&(M[A]=v+1);const w=v+1,F=[];for(let A=0;A<=v+1;A++)F.push([]);for(let A=0;A<m;A++)F[M[A]].push(A);const S=Math.max(c*2,a-c),C=new Float64Array(w);C[0]=0;let T=0;for(let A=1;A<w;A++){const k=((B=F[A])==null?void 0:B.length)??0,$=k>1?k*c*1.2/(2*Math.PI):c,D=T+c*1.6,te=A/w*S;C[A]=Math.max(te,$,D),T=C[A]}const O=new Array(w);for(let A=0;A<w;A++){O[A]=new Float64Array(F[A].length);for(let k=0;k<F[A].length;k++)O[A][k]=k}const Y=new Float64Array(m);for(let A=0;A<w;A++)for(let k=0;k<F[A].length;k++)Y[F[A][k]]=O[A][k];const X=(y.get(o[I])??this.hashId(o[I]))%1e4/1e4*fe,q=new Float64Array(m);(()=>{q[I]=0;for(let A=1;A<w;A++){const k=F[A],$=k.length;if($!==0)for(let D=0;D<$;D++)q[k[D]]=X+D/$*fe}})();for(let A=0;A<x;A++){for(let k=1;k<w;k++){const $=F[k];if(!($.length<=1)){this.barycentricSort($,k,f,o,_,M,q,X);for(let D=0;D<$.length;D++)q[$[D]]=X+D/$.length*fe}}for(let k=w-2;k>=1;k--){const $=F[k];if(!($.length<=1)){this.barycentricSort($,k,f,o,_,M,q,X);for(let D=0;D<$.length;D++)q[$[D]]=X+D/$.length*fe}}if(A===x-1||m<=60)for(let k=1;k<w;k++){const $=F[k];if(!($.length<=2)){this.adjacentSwapPass($,k,f,o,_,M,q,X);for(let D=0;D<$.length;D++)q[$[D]]=X+D/$.length*fe}}}const J=new Float64Array(m),L=new Float64Array(m);J[I]=r,L[I]=i;for(let A=1;A<w;A++){const k=F[A],$=k.length;for(let D=0;D<$;D++){const te=k[D],ae=X+D/$*fe;J[te]=r+Math.cos(ae)*C[A],L[te]=i+Math.sin(ae)*C[A]}}const H=h.communityAnchorById.get(n);H&&this.alignRotation(J,L,o,r,i,H,h,m);const oe=H?r-H.x:0,se=H?i-H.y:0,ce=1-d,me=a*1.05;for(let A=0;A<m;A++){const k=h.nodePositions[o[A]];if(k&&d>0){const $=k.x+oe,D=k.y+se;p[A]=$+(J[A]-$)*ce,g[A]=D+(L[A]-D)*ce}else p[A]=J[A],g[A]=L[A]}return this.clampToContainment(p,g,r,i,me,m),{nodeIds:o,x:p,y:g}}barycentricSort(t,n,o,r,i,a,c,d){const l=t.length;if(l<=1)return;const u=new Float64Array(l);for(let h=0;h<l;h++){const m=t[h],p=o.get(r[m]);let g=0,x=0,_=0;if(p)for(const I of p){const P=i.get(I);if(P==null||a[P]===n)continue;const M=c[P];x+=Math.cos(M),g+=Math.sin(M),_++}_>0?(u[h]=Math.atan2(g/_,x/_),u[h]<d&&(u[h]+=fe)):u[h]=d+h/l*fe}const f=Array.from({length:l},(h,m)=>m);f.sort((h,m)=>{const p=u[h]-u[m];return Math.abs(p)>1e-12?p:ye(r[t[h]],r[t[m]])});const y=t.slice();for(let h=0;h<l;h++)t[h]=y[f[h]]}adjacentSwapPass(t,n,o,r,i,a,c,d){const l=t.length,u=Math.min(l,6);for(let f=0;f<u;f++){let y=!1;for(let h=0;h<l-1;h++){const m=t[h],p=t[h+1],g=d+h/l*fe,x=d+(h+1)/l*fe,_=this.localCrossings(m,p,g,n,o,r,i,a,c);this.localCrossings(p,m,g,n,o,r,i,a,c)<_&&(t[h]=p,t[h+1]=m,c[p]=g,c[m]=x,y=!0)}if(!y)break}}localCrossings(t,n,o,r,i,a,c,d,l){const u=[],f=[],y=i.get(a[t]),h=i.get(a[n]);if(y)for(const p of y){const g=c.get(p);g!=null&&d[g]!==r&&u.push(l[g])}if(h)for(const p of h){const g=c.get(p);g!=null&&d[g]!==r&&f.push(l[g])}let m=0;for(const p of u)for(const g of f){const x=(p-o+fe*2)%fe,_=(g-o+fe*2)%fe;x>_&&m++}return m}alignRotation(t,n,o,r,i,a,c,d){let l=0,u=0,f=0;for(let p=0;p<d;p++){const g=c.nodePositions[o[p]];if(!g)continue;const x=t[p]-r,_=n[p]-i,I=g.x-a.x,P=g.y-a.y;x*x+_*_<ue||I*I+P*P<ue||(l+=x*I+_*P,u+=x*P-_*I,f++)}if(f<3||l*l+u*u<ue)return;const y=Math.atan2(u,l);if(Math.abs(y)<.01)return;const h=Math.cos(y),m=Math.sin(y);for(let p=0;p<d;p++){const g=t[p]-r,x=n[p]-i;t[p]=r+g*h-x*m,n[p]=i+g*m+x*h}}}const fs={strategy:"radial-sugiyama",label:"Radial Sugiyama",fields:[{key:"quality",label:"Quality",min:.5,max:1.5,step:.05},{key:"stability",label:"Stability",min:0,max:.95,step:.05},{key:"nodeSpacing",label:"Node Spacing",min:4,max:20,step:1},{key:"sweepPasses",label:"Sweep Passes",min:1,max:8,step:1}],createInitialConfig:()=>({quality:un,stability:fn,nodeSpacing:ls,sweepPasses:Ot}),summarizeConfig:s=>`q=${Number(s.quality??un).toFixed(2)} stab=${Number(s.stability??fn).toFixed(2)} sweeps=${Number(s.sweepPasses??Ot)}`,createAlgorithm:()=>new us},hn=1,mn=.8,hs=8,Ft=1.2,$t=5;class ms extends xt{constructor(){super(...arguments);W(this,"strategy","stress-majorization")}layoutNodesInCommunity(t){const{communityId:n,nodeIds:o,anchorX:r,anchorY:i,communityRadius:a,nodeSpacing:c,stability:d,quality:l,strategyConfig:u,adjacencyByNodeId:f,nodeHashById:y,previousIndex:h}=t,m=o.length,p=new Float64Array(m),g=new Float64Array(m);if(m===0)return{nodeIds:o,x:p,y:g};const x=de(u,"anchorWeight",Ft,0,4),_=Math.round(de(u,"maxHops",$t,2,10)),I=st(Math.round(12*l*(m<=60?1.5:m<=250?1.1:m<=800?.8:.6)),3,25),P=new Map;for(let B=0;B<m;B++)P.set(o[B],B);const M=h.communityAnchorById.get(n),N=M?r-M.x:0,R=M?i-M.y:0,b=a*1.05,E=Math.max(c*3,a-c*2),v=new Float64Array(m),w=new Float64Array(m),F=new Uint8Array(m);for(let B=0;B<m;B++){const A=h.nodePositions[o[B]];if(A){p[B]=A.x+N,g[B]=A.y+R,v[B]=p[B],w[B]=g[B],F[B]=1;const k=p[B]-r,$=g[B]-i,D=Math.sqrt(k*k+$*$);D>b&&(p[B]=r+k*b/D,g[B]=i+$*b/D)}else{let k=0,$=0,D=0;const te=f.get(o[B]);if(te)for(const ae of te){const ie=P.get(ae);if(ie!=null&&F[ie]&&(k+=p[ie],$+=g[ie],D++,D>=4))break}if(D>0)p[B]=k/D,g[B]=$/D;else{const ae=y.get(o[B])??B,ie=B*Math.PI*(3-Math.sqrt(5))+ae%1e4/1e4*2*Math.PI,pe=Math.sqrt((B+.5)/Math.max(1,m))*E;p[B]=r+Math.cos(ie)*pe,g[B]=i+Math.sin(ie)*pe}v[B]=p[B],w[B]=g[B]}}const S=c*2.2,C=new Int32Array(m),T=new Int32Array(m+4),O=new Int32Array(m);for(let B=0;B<m;B++){O.fill(-1),O[B]=0,T[0]=B;let A=0,k=1;for(;A<k;){const $=T[A++],D=O[$];if(D>=_)continue;const te=f.get(o[$]);if(te)for(const ae of te){const ie=P.get(ae);ie==null||O[ie]!==-1||(O[ie]=D+1,T[k++]=ie,C[B]++)}}}const Y=new Int32Array(m+1);for(let B=0;B<m;B++)Y[B+1]=Y[B]+C[B];const X=Y[m],q=new Int32Array(X),Q=new Float64Array(X),J=new Float64Array(X),L=new Float64Array(m),H=new Int32Array(m);for(let B=0;B<m;B++){O.fill(-1),O[B]=0,T[0]=B;let A=0,k=1;for(;A<k;){const $=T[A++],D=O[$];if(D>=_)continue;const te=f.get(o[$]);if(te)for(const ae of te){const ie=P.get(ae);if(ie==null||O[ie]!==-1)continue;O[ie]=D+1,T[k++]=ie;const pe=(D+1)*S,Me=1/(pe*pe+ue),Ee=Y[B]+H[B];q[Ee]=ie,Q[Ee]=pe,J[Ee]=Me,H[B]++,L[B]+=Me}}}const oe=new Float64Array(m),se=new Float64Array(m);for(let B=0;B<I;B++){for(let A=0;A<m;A++){const k=Y[A],$=Y[A+1];let D=0,te=0;for(let pe=k;pe<$;pe++){const Me=q[pe],Ee=Q[pe],pt=J[pe];let De=p[A]-p[Me],Ue=g[A]-g[Me],Ye=Math.sqrt(De*De+Ue*Ue);if(Ye<ue){const es=(A*997+Me*991+B*37)%360*(2*Math.PI/360);De=Math.cos(es)*.01,Ue=Math.sin(es)*.01,Ye=.01}D+=pt*(p[Me]+Ee*(De/Ye)),te+=pt*(g[Me]+Ee*(Ue/Ye))}const ae=x*(F[A]?1:.3),ie=L[A]+ae;ie<ue?(oe[A]=p[A],se[A]=g[A]):(oe[A]=(D+ae*v[A])/ie,se[A]=(te+ae*w[A])/ie)}for(let A=0;A<m;A++)p[A]=oe[A],g[A]=se[A];this.clampToContainment(p,g,r,i,b,m)}const ce=.06;for(let B=0;B<m;B++)p[B]+=(r-p[B])*ce,g[B]+=(i-g[B])*ce;const me=d*.35;if(me>.01&&M)for(let B=0;B<m;B++)F[B]&&(p[B]=v[B]+(p[B]-v[B])*(1-me),g[B]=w[B]+(g[B]-w[B])*(1-me));return this.clampToContainment(p,g,r,i,b,m),m>1&&m<=800&&this.resolveCollisions(p,g,r,i,c,b,m),{nodeIds:o,x:p,y:g}}resolveCollisions(t,n,o,r,i,a,c){const d=i*.88,l=c<=200?2:1;for(let u=0;u<l;u++){if(c<=350)for(let f=0;f<c;f++)for(let y=f+1;y<c;y++){let h=t[f]-t[y],m=n[f]-n[y];const p=h*h+m*m;if(p>=d*d)continue;const g=Math.sqrt(p)||ue,x=(d-g)*.5;h/=g,m/=g,t[f]+=h*x,n[f]+=m*x,t[y]-=h*x,n[y]-=m*x}else{const f=d*2,y=this.makeGridStore();for(let p=0;p<c;p++)this.gridPush(y,this.gridKey(t[p],n[p],f),p);const h=new Float64Array(c),m=new Float64Array(c);for(let p=0;p<c;p++){const g=Math.floor(t[p]/f),x=Math.floor(n[p]/f);for(let _=-1;_<=1;_++)for(let I=-1;I<=1;I++){const P=this.gridKey((g+_)*f,(x+I)*f,f),M=y.buckets.get(P);if(M)for(const N of M){if(N<=p)continue;let R=t[p]-t[N],b=n[p]-n[N];const E=R*R+b*b;if(E>=d*d)continue;const v=Math.sqrt(E)||ue,w=(d-v)*.5;R/=v,b/=v,h[p]+=R*w,m[p]+=b*w,h[N]-=R*w,m[N]-=b*w}}}this.gridClear(y);for(let p=0;p<c;p++)t[p]+=h[p],n[p]+=m[p]}this.clampToContainment(t,n,o,r,a,c)}}makeGridStore(){return{buckets:new Map,usedKeys:[],pool:[]}}}const ys={strategy:"stress-majorization",label:"Stress Majorization",fields:[{key:"quality",label:"Quality",min:.5,max:1.5,step:.05},{key:"stability",label:"Stability",min:0,max:.95,step:.05},{key:"nodeSpacing",label:"Node Spacing",min:4,max:20,step:1},{key:"anchorWeight",label:"Anchor Weight",min:0,max:4,step:.1},{key:"maxHops",label:"Max Hops",min:2,max:10,step:1}],createInitialConfig:()=>({quality:hn,stability:mn,nodeSpacing:hs,anchorWeight:Ft,maxHops:$t}),summarizeConfig:s=>`q=${Number(s.quality??hn).toFixed(2)} stab=${Number(s.stability??mn).toFixed(2)} anc=${Number(s.anchorWeight??Ft).toFixed(1)} hops=${Number(s.maxHops??$t)}`,createAlgorithm:()=>new ms},yn=8,pn=.8,gn=1;class ps extends xt{constructor(){super(...arguments);W(this,"strategy","strict-temporal")}layoutNodesInCommunity(t){const{communityId:n,nodeIds:o,anchorX:r,anchorY:i,communityRadius:a,nodeSpacing:c,stability:d,quality:l,adjacencyByNodeId:u,nodeHashById:f,previousIndex:y}=t,h=o.length,m=new Float64Array(h),p=new Float64Array(h);if(h===0)return{nodeIds:o,x:m,y:p};const g=new Map;for(let b=0;b<h;b++)g.set(o[b],b);const x=new Float64Array(h),_=new Float64Array(h);this.computeBFSRingLayout({nodeIds:o,localIndex:g,anchorX:r,anchorY:i,communityRadius:a,nodeSpacing:c,adjacencyByNodeId:u,nodeHashById:f,targetX:x,targetY:_});const I=y.communityAnchorById.get(n);I&&this.alignTargetRotation({nodeIds:o,targetX:x,targetY:_,anchorX:r,anchorY:i,prevAnchor:I,previousIndex:y});const P=I?r-I.x:0,M=I?i-I.y:0,N=1-d;for(let b=0;b<h;b++){const E=y.nodePositions[o[b]];if(E&&d>0){const v=E.x+P,w=E.y+M;m[b]=v+(x[b]-v)*N,p[b]=w+(_[b]-w)*N}else m[b]=x[b],p[b]=_[b]}const R=a*1.08;if(this.clampToContainment(m,p,r,i,R,h),h>1){const b=h<=300?Math.round(3*l):h<=1e3?Math.round(2*l):1;this.resolveNodeCollisions({x:m,y:p,anchorX:r,anchorY:i,nodeSpacing:c,containR:R,n:h,iterations:b})}return{nodeIds:o,x:m,y:p}}computeBFSRingLayout(t){var F;const{nodeIds:n,localIndex:o,anchorX:r,anchorY:i,communityRadius:a,nodeSpacing:c,adjacencyByNodeId:d,nodeHashById:l,targetX:u,targetY:f}=t,y=n.length;if(y===1){u[0]=r,f[0]=i;return}let h=0,m=-1;for(let S=0;S<y;S++){let C=0;const T=d.get(n[S]);if(T)for(const O of T)o.has(O)&&C++;(C>m||C===m&&ye(n[S],n[h])<0)&&(m=C,h=S)}const p=new Int32Array(y).fill(-1),g=new Int32Array(y).fill(-1),x=[h];p[h]=0;let _=0,I=0;for(;_<x.length;){const S=x[_++],C=p[S],T=d.get(n[S]);if(T)for(const O of T){const Y=o.get(O);Y==null||p[Y]!==-1||(p[Y]=C+1,g[Y]=S,C+1>I&&(I=C+1),x.push(Y))}}let P=!1;for(let S=0;S<y;S++)p[S]===-1&&(p[S]=I+1,P=!0);const M=I+(P?2:1),N=[];for(let S=0;S<y;S++){const C=p[S];for(;N.length<=C;)N.push([]);N[C].push(S)}const R=Math.max(c*2,a-c),b=M>1?R/(M-.5):R,E=new Float64Array(M);let v=0;for(let S=1;S<M;S++){const C=((F=N[S])==null?void 0:F.length)??0,T=C>1?C*c*1.15/(2*Math.PI):0,O=v+c*1.5,Y=S*b;E[S]=Math.max(Y,T,O),v=E[S]}u[h]=r,f[h]=i;const w=(l.get(n[h])??0)%1e4/1e4*fe;for(let S=1;S<N.length;S++){const C=N[S];if(!C||C.length===0)continue;const T=E[S],O=C.length,Y=C.map(q=>{const Q=g[q];let J;if(Q>=0){const L=u[Q]-r,H=f[Q]-i;J=Math.sqrt(L*L+H*H)>ue?Math.atan2(H,L):0}else J=(l.get(n[q])??0)%1e4/1e4*fe;return{i:q,parentAngle:J}});Y.sort((q,Q)=>{const J=q.parentAngle-Q.parentAngle;return Math.abs(J)>1e-12?J:ye(n[q.i],n[Q.i])});const X=Y[0].parentAngle+w;for(let q=0;q<O;q++){const Q=X+q/O*fe,{i:J}=Y[q];u[J]=r+Math.cos(Q)*T,f[J]=i+Math.sin(Q)*T}}}alignTargetRotation(t){const{nodeIds:n,targetX:o,targetY:r,anchorX:i,anchorY:a,prevAnchor:c,previousIndex:d}=t,l=n.length;let u=0,f=0,y=0;for(let g=0;g<l;g++){const x=d.nodePositions[n[g]];if(!x)continue;const _=o[g]-i,I=r[g]-a,P=x.x-c.x,M=x.y-c.y;_*_+I*I<ue||P*P+M*M<ue||(u+=_*P+I*M,f+=_*M-I*P,y++)}if(y<2||u*u+f*f<ue)return;const h=Math.atan2(f,u);if(Math.abs(h)<.008)return;const m=Math.cos(h),p=Math.sin(h);for(let g=0;g<l;g++){const x=o[g]-i,_=r[g]-a;o[g]=i+x*m-_*p,r[g]=a+x*p+_*m}}resolveNodeCollisions(t){const{x:n,y:o,anchorX:r,anchorY:i,nodeSpacing:a,containR:c,n:d,iterations:l}=t,u=a*.85;if(d<=400)for(let f=0;f<l;f++){for(let y=0;y<d;y++)for(let h=y+1;h<d;h++){let m=n[y]-n[h],p=o[y]-o[h];const g=m*m+p*p;if(g>=u*u)continue;const x=Math.sqrt(g)||ue,_=(u-x)*.5;m/=x,p/=x,n[y]+=m*_,o[y]+=p*_,n[h]-=m*_,o[h]-=p*_}this.clampToContainment(n,o,r,i,c,d)}else{const f=u*2,y=this.makeGridStore(),h=new Float64Array(d),m=new Float64Array(d);for(let p=0;p<l;p++){h.fill(0),m.fill(0),this.gridClear(y);for(let g=0;g<d;g++)this.gridPush(y,this.gridKey(n[g],o[g],f),g);for(let g=0;g<d;g++){const x=Math.floor(n[g]/f),_=Math.floor(o[g]/f);for(let I=-1;I<=1;I++)for(let P=-1;P<=1;P++){const M=y.buckets.get(this.gridKey((x+I)*f,(_+P)*f,f));if(M)for(const N of M){if(N<=g)continue;let R=n[g]-n[N],b=o[g]-o[N];const E=R*R+b*b;if(E>=u*u)continue;const v=Math.sqrt(E)||ue,w=(u-v)*.5;R/=v,b/=v,h[g]+=R*w,m[g]+=b*w,h[N]-=R*w,m[N]-=b*w}}}for(let g=0;g<d;g++)n[g]+=h[g],o[g]+=m[g];this.clampToContainment(n,o,r,i,c,d)}}}makeGridStore(){return{buckets:new Map,usedKeys:[],pool:[]}}}const gs={strategy:"strict-temporal",label:"Strict Temporal",fields:[{key:"quality",label:"Quality",min:.5,max:1.5,step:.05},{key:"stability",label:"Stability",min:0,max:.95,step:.05},{key:"nodeSpacing",label:"Node Spacing",min:4,max:20,step:1}],createInitialConfig:()=>({quality:gn,stability:pn,nodeSpacing:yn}),summarizeConfig:s=>{const e=Number(s.quality??gn),t=Number(s.stability??pn),n=Number(s.nodeSpacing??yn);return`q=${e.toFixed(2)} stab=${t.toFixed(2)} space=${n}`},createAlgorithm:()=>new ps},xn=1,_n=.85,In=10,_t=1e-4,bn=.05;class xs{constructor(){W(this,"strategy","balanced-temporal")}run(e){var E;const t=de(e.strategyConfig,"quality",xn,.1,2),n=de(e.strategyConfig,"stability",_n,0,1),o=de(e.strategyConfig,"nodeSpacing",In,5,50),r=Math.round(150*t),i=o*4,a=o*1.5,c=n*.15,d=this.parseSnapshot(e.previousState),l=e.nodeIds,u=e.adjacencyByNodeId,f=this.computeConnectedComponents(l,u),y=new Map;for(const v of f){const w=`comp:${v[0]}`;for(const F of v)y.set(F,w)}const h=[],m=new Map,p=[...l].sort();for(let v=0;v<p.length;v++){const w=p[v],F=d.get(w);let S=0,C=0,T=!0;if(F)S=F.x,C=F.y,T=!1;else{const O=u.get(w);let Y=0,X=0,q=0;if(O)for(const Q of O){const J=d.get(Q);J&&(Y+=J.x,X+=J.y,q++)}if(q>0)S=Y/q,C=X/q,S+=(Math.random()-.5)*o*.1,C+=(Math.random()-.5)*o*.1;else{const Q=v*.1,J=o*5;S=Math.cos(Q)*J,C=Math.sin(Q)*J}}h.push({id:w,x:S,y:C,vx:0,vy:0,fx:0,fy:0,prevX:F==null?void 0:F.x,prevY:F==null?void 0:F.y,isNew:T,componentId:y.get(w)||"unknown",mass:1+(((E=u.get(w))==null?void 0:E.size)||0)*.5}),m.set(w,v)}const g=[];for(const v of p){const w=m.get(v);if(w===void 0)continue;const F=u.get(v);if(F)for(const S of F){const C=m.get(S);C!==void 0&&w<C&&g.push({source:w,target:C,weight:1})}}const x=.5,_=.85,I=Math.max(20,i);for(let v=0;v<r;v++){const w=(1-v/r)*(1-n*.5);for(let S=0;S<h.length;S++)h[S].fx=0,h[S].fy=0;for(const S of g){const C=h[S.source],T=h[S.target],O=T.x-C.x,Y=T.y-C.y;let X=Math.sqrt(O*O+Y*Y);X<_t&&(X=_t);const q=X-a,J=.05*w*q,L=O/X*J,H=Y/X*J;C.fx+=L,C.fy+=H,T.fx-=L,T.fy-=H}const F=new Map;for(let S=0;S<h.length;S++){const C=Math.floor(h[S].x/I),T=Math.floor(h[S].y/I),O=`${C},${T}`,Y=F.get(O);Y?Y.push(S):F.set(O,[S])}for(let S=0;S<h.length;S++){const C=h[S],T=Math.floor(C.x/I),O=Math.floor(C.y/I);for(let Y=-1;Y<=1;Y++)for(let X=-1;X<=1;X++){const q=`${T+Y},${O+X}`,Q=F.get(q);if(Q)for(const J of Q){if(S===J)continue;const L=h[J],H=C.x-L.x,oe=C.y-L.y;let se=H*H+oe*oe;if(se>i*i)continue;se<_t&&(se=_t,C.fx+=Math.random(),C.fy+=Math.random());const ce=Math.sqrt(se),me=o*15*w/ce,B=H/ce*me,A=oe/ce*me;C.fx+=B,C.fy+=A}}}for(let S=0;S<h.length;S++){const C=h[S];C.fx-=C.x*bn*w,C.fy-=C.y*bn*w}if(c>0)for(let S=0;S<h.length;S++){const C=h[S];if(C.prevX!==void 0&&C.prevY!==void 0){const T=C.prevX-C.x,O=C.prevY-C.y;C.isNew||(C.fx+=T*c,C.fy+=O*c)}}for(let S=0;S<h.length;S++){const C=h[S],T=100;C.fx=Math.max(-T,Math.min(T,C.fx)),C.fy=Math.max(-T,Math.min(T,C.fy)),C.vx=(C.vx+C.fx*x)*_,C.vy=(C.vy+C.fy*x)*_,C.x+=C.vx*x,C.y+=C.vy*x}}const P=[],M={},N=[],R=[],b=new Map;for(const v of h){b.has(v.componentId)||b.set(v.componentId,{x:0,y:0,count:0});const w=b.get(v.componentId);w.x+=v.x,w.y+=v.y,w.count++}for(const[v,w]of b)w.x/=w.count,w.y/=w.count,N.push({componentId:v,nodeIds:[],anchorX:w.x,anchorY:w.y});for(const v of h){M[v.id]={x:v.x,y:v.y};const w=b.get(v.componentId)||{x:v.x,y:v.y};let F=0,S=0,C=0;const T=u.get(v.id);if(T)for(const O of T){const Y=m.get(O);Y!==void 0&&(F+=h[Y].x,S+=h[Y].y,C++)}C===0?(F=v.x,S=v.y):(F/=C,S/=C),P.push({nodeId:v.id,targetX:v.x,targetY:v.y,componentId:v.componentId,communityId:"default",anchorX:w.x,anchorY:w.y,neighborX:F,neighborY:S})}return{layout:{components:N,communities:R,nodeTargets:P},metadata:{state:{version:3,nodePositions:M}}}}parseSnapshot(e){const t=new Map;if(!e||typeof e!="object")return t;const o=e.nodePositions;if(o&&typeof o=="object")for(const[r,i]of Object.entries(o)){const a=i;typeof a.x=="number"&&typeof a.y=="number"&&t.set(r,{x:a.x,y:a.y})}return t}computeConnectedComponents(e,t){const n=new Set,o=[];for(const r of e){if(n.has(r))continue;const i=[],a=[r];for(n.add(r);a.length>0;){const c=a.pop();i.push(c);const d=t.get(c);if(d)for(const l of d)n.has(l)||(n.add(l),a.push(l))}o.push(i)}return o.sort((r,i)=>i.length-r.length),o}}const Lt=[ds,{strategy:"balanced-temporal",label:"Balanced Temporal",fields:[{key:"quality",label:"Simulation Steps",min:.1,max:2,step:.1},{key:"stability",label:"Stability",min:0,max:1,step:.05},{key:"nodeSpacing",label:"Node Spacing",min:5,max:50,step:1}],createInitialConfig:()=>({quality:xn,stability:_n,nodeSpacing:In}),summarizeConfig:s=>`Q:${s.quality} S:${s.stability} Sp:${s.nodeSpacing}`,createAlgorithm:()=>new xs},gs,rn,is,ys,fs];rn.strategy,new Map(Lt.map(s=>[s.strategy,s])),Lt.map(s=>({value:s.strategy,label:s.label}));function _s(){return new Map(Lt.map(s=>{const e=s.createAlgorithm();return[s.strategy,e]}))}const Is=_s();function vn(s,e){const t=Is.get(s);if(!t)throw new Error(`[network-layout] Unknown strategy: ${s}`);return t.run(e)}var ne;(function(s){s.assertEqual=o=>{};function e(o){}s.assertIs=e;function t(o){throw new Error}s.assertNever=t,s.arrayToEnum=o=>{const r={};for(const i of o)r[i]=i;return r},s.getValidEnumValues=o=>{const r=s.objectKeys(o).filter(a=>typeof o[o[a]]!="number"),i={};for(const a of r)i[a]=o[a];return s.objectValues(i)},s.objectValues=o=>s.objectKeys(o).map(function(r){return o[r]}),s.objectKeys=typeof Object.keys=="function"?o=>Object.keys(o):o=>{const r=[];for(const i in o)Object.prototype.hasOwnProperty.call(o,i)&&r.push(i);return r},s.find=(o,r)=>{for(const i of o)if(r(i))return i},s.isInteger=typeof Number.isInteger=="function"?o=>Number.isInteger(o):o=>typeof o=="number"&&Number.isFinite(o)&&Math.floor(o)===o;function n(o,r=" | "){return o.map(i=>typeof i=="string"?`'${i}'`:i).join(r)}s.joinValues=n,s.jsonStringifyReplacer=(o,r)=>typeof r=="bigint"?r.toString():r})(ne||(ne={}));var wn;(function(s){s.mergeShapes=(e,t)=>({...e,...t})})(wn||(wn={}));const z=ne.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Pe=s=>{switch(typeof s){case"undefined":return z.undefined;case"string":return z.string;case"number":return Number.isNaN(s)?z.nan:z.number;case"boolean":return z.boolean;case"function":return z.function;case"bigint":return z.bigint;case"symbol":return z.symbol;case"object":return Array.isArray(s)?z.array:s===null?z.null:s.then&&typeof s.then=="function"&&s.catch&&typeof s.catch=="function"?z.promise:typeof Map<"u"&&s instanceof Map?z.map:typeof Set<"u"&&s instanceof Set?z.set:typeof Date<"u"&&s instanceof Date?z.date:z.object;default:return z.unknown}},j=ne.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class Re extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=n=>{this.issues=[...this.issues,n]},this.addIssues=(n=[])=>{this.issues=[...this.issues,...n]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(r){return r.message},n={_errors:[]},o=r=>{for(const i of r.issues)if(i.code==="invalid_union")i.unionErrors.map(o);else if(i.code==="invalid_return_type")o(i.returnTypeError);else if(i.code==="invalid_arguments")o(i.argumentsError);else if(i.path.length===0)n._errors.push(t(i));else{let a=n,c=0;for(;c<i.path.length;){const d=i.path[c];c===i.path.length-1?(a[d]=a[d]||{_errors:[]},a[d]._errors.push(t(i))):a[d]=a[d]||{_errors:[]},a=a[d],c++}}};return o(this),n}static assert(e){if(!(e instanceof Re))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,ne.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){const t={},n=[];for(const o of this.issues)if(o.path.length>0){const r=o.path[0];t[r]=t[r]||[],t[r].push(e(o))}else n.push(e(o));return{formErrors:n,fieldErrors:t}}get formErrors(){return this.flatten()}}Re.create=s=>new Re(s);const Dt=(s,e)=>{let t;switch(s.code){case j.invalid_type:s.received===z.undefined?t="Required":t=`Expected ${s.expected}, received ${s.received}`;break;case j.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(s.expected,ne.jsonStringifyReplacer)}`;break;case j.unrecognized_keys:t=`Unrecognized key(s) in object: ${ne.joinValues(s.keys,", ")}`;break;case j.invalid_union:t="Invalid input";break;case j.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${ne.joinValues(s.options)}`;break;case j.invalid_enum_value:t=`Invalid enum value. Expected ${ne.joinValues(s.options)}, received '${s.received}'`;break;case j.invalid_arguments:t="Invalid function arguments";break;case j.invalid_return_type:t="Invalid function return type";break;case j.invalid_date:t="Invalid date";break;case j.invalid_string:typeof s.validation=="object"?"includes"in s.validation?(t=`Invalid input: must include "${s.validation.includes}"`,typeof s.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${s.validation.position}`)):"startsWith"in s.validation?t=`Invalid input: must start with "${s.validation.startsWith}"`:"endsWith"in s.validation?t=`Invalid input: must end with "${s.validation.endsWith}"`:ne.assertNever(s.validation):s.validation!=="regex"?t=`Invalid ${s.validation}`:t="Invalid";break;case j.too_small:s.type==="array"?t=`Array must contain ${s.exact?"exactly":s.inclusive?"at least":"more than"} ${s.minimum} element(s)`:s.type==="string"?t=`String must contain ${s.exact?"exactly":s.inclusive?"at least":"over"} ${s.minimum} character(s)`:s.type==="number"?t=`Number must be ${s.exact?"exactly equal to ":s.inclusive?"greater than or equal to ":"greater than "}${s.minimum}`:s.type==="bigint"?t=`Number must be ${s.exact?"exactly equal to ":s.inclusive?"greater than or equal to ":"greater than "}${s.minimum}`:s.type==="date"?t=`Date must be ${s.exact?"exactly equal to ":s.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(s.minimum))}`:t="Invalid input";break;case j.too_big:s.type==="array"?t=`Array must contain ${s.exact?"exactly":s.inclusive?"at most":"less than"} ${s.maximum} element(s)`:s.type==="string"?t=`String must contain ${s.exact?"exactly":s.inclusive?"at most":"under"} ${s.maximum} character(s)`:s.type==="number"?t=`Number must be ${s.exact?"exactly":s.inclusive?"less than or equal to":"less than"} ${s.maximum}`:s.type==="bigint"?t=`BigInt must be ${s.exact?"exactly":s.inclusive?"less than or equal to":"less than"} ${s.maximum}`:s.type==="date"?t=`Date must be ${s.exact?"exactly":s.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(s.maximum))}`:t="Invalid input";break;case j.custom:t="Invalid input";break;case j.invalid_intersection_types:t="Intersection results could not be merged";break;case j.not_multiple_of:t=`Number must be a multiple of ${s.multipleOf}`;break;case j.not_finite:t="Number must be finite";break;default:t=e.defaultError,ne.assertNever(s)}return{message:t}};let bs=Dt;function vs(){return bs}const ws=s=>{const{data:e,path:t,errorMaps:n,issueData:o}=s,r=[...t,...o.path||[]],i={...o,path:r};if(o.message!==void 0)return{...o,path:r,message:o.message};let a="";const c=n.filter(d=>!!d).slice().reverse();for(const d of c)a=d(i,{data:e,defaultError:a}).message;return{...o,path:r,message:a}};function U(s,e){const t=vs(),n=ws({issueData:e,data:s.data,path:s.path,errorMaps:[s.common.contextualErrorMap,s.schemaErrorMap,t,t===Dt?void 0:Dt].filter(o=>!!o)});s.common.issues.push(n)}class ge{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){const n=[];for(const o of t){if(o.status==="aborted")return K;o.status==="dirty"&&e.dirty(),n.push(o.value)}return{status:e.value,value:n}}static async mergeObjectAsync(e,t){const n=[];for(const o of t){const r=await o.key,i=await o.value;n.push({key:r,value:i})}return ge.mergeObjectSync(e,n)}static mergeObjectSync(e,t){const n={};for(const o of t){const{key:r,value:i}=o;if(r.status==="aborted"||i.status==="aborted")return K;r.status==="dirty"&&e.dirty(),i.status==="dirty"&&e.dirty(),r.value!=="__proto__"&&(typeof i.value<"u"||o.alwaysSet)&&(n[r.value]=i.value)}return{status:e.value,value:n}}}const K=Object.freeze({status:"aborted"}),ct=s=>({status:"dirty",value:s}),Ie=s=>({status:"valid",value:s}),kn=s=>s.status==="aborted",Sn=s=>s.status==="dirty",Ze=s=>s.status==="valid",It=s=>typeof Promise<"u"&&s instanceof Promise;var Z;(function(s){s.errToObj=e=>typeof e=="string"?{message:e}:e||{},s.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})(Z||(Z={}));class Ce{constructor(e,t,n,o){this._cachedPath=[],this.parent=e,this.data=t,this._path=n,this._key=o}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const An=(s,e)=>{if(Ze(e))return{success:!0,data:e.value};if(!s.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new Re(s.common.issues);return this._error=t,this._error}}};function G(s){if(!s)return{};const{errorMap:e,invalid_type_error:t,required_error:n,description:o}=s;if(e&&(t||n))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:o}:{errorMap:(i,a)=>{const{message:c}=s;return i.code==="invalid_enum_value"?{message:c??a.defaultError}:typeof a.data>"u"?{message:c??n??a.defaultError}:i.code!=="invalid_type"?{message:a.defaultError}:{message:c??t??a.defaultError}},description:o}}class ee{get description(){return this._def.description}_getType(e){return Pe(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:Pe(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new ge,ctx:{common:e.parent.common,data:e.data,parsedType:Pe(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(It(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const n=this.safeParse(e,t);if(n.success)return n.data;throw n.error}safeParse(e,t){const n={common:{issues:[],async:(t==null?void 0:t.async)??!1,contextualErrorMap:t==null?void 0:t.errorMap},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Pe(e)},o=this._parseSync({data:e,path:n.path,parent:n});return An(n,o)}"~validate"(e){var n,o;const t={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Pe(e)};if(!this["~standard"].async)try{const r=this._parseSync({data:e,path:[],parent:t});return Ze(r)?{value:r.value}:{issues:t.common.issues}}catch(r){(o=(n=r==null?void 0:r.message)==null?void 0:n.toLowerCase())!=null&&o.includes("encountered")&&(this["~standard"].async=!0),t.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:t}).then(r=>Ze(r)?{value:r.value}:{issues:t.common.issues})}async parseAsync(e,t){const n=await this.safeParseAsync(e,t);if(n.success)return n.data;throw n.error}async safeParseAsync(e,t){const n={common:{issues:[],contextualErrorMap:t==null?void 0:t.errorMap,async:!0},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Pe(e)},o=this._parse({data:e,path:n.path,parent:n}),r=await(It(o)?o:Promise.resolve(o));return An(n,r)}refine(e,t){const n=o=>typeof t=="string"||typeof t>"u"?{message:t}:typeof t=="function"?t(o):t;return this._refinement((o,r)=>{const i=e(o),a=()=>r.addIssue({code:j.custom,...n(o)});return typeof Promise<"u"&&i instanceof Promise?i.then(c=>c?!0:(a(),!1)):i?!0:(a(),!1)})}refinement(e,t){return this._refinement((n,o)=>e(n)?!0:(o.addIssue(typeof t=="function"?t(n,o):t),!1))}_refinement(e){return new Ke({schema:this,typeName:V.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:t=>this["~validate"](t)}}optional(){return je.create(this,this._def)}nullable(){return He.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return Ne.create(this)}promise(){return St.create(this,this._def)}or(e){return vt.create([this,e],this._def)}and(e){return wt.create(this,e,this._def)}transform(e){return new Ke({...G(this._def),schema:this,typeName:V.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t=typeof e=="function"?e:()=>e;return new Xt({...G(this._def),innerType:this,defaultValue:t,typeName:V.ZodDefault})}brand(){return new qs({typeName:V.ZodBranded,type:this,...G(this._def)})}catch(e){const t=typeof e=="function"?e:()=>e;return new qt({...G(this._def),innerType:this,catchValue:t,typeName:V.ZodCatch})}describe(e){const t=this.constructor;return new t({...this._def,description:e})}pipe(e){return Vt.create(this,e)}readonly(){return Kt.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const ks=/^c[^\s-]{8,}$/i,Ss=/^[0-9a-z]+$/,As=/^[0-9A-HJKMNP-TV-Z]{26}$/i,Ms=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Cs=/^[a-z0-9_-]{21}$/i,Ts=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,Ns=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,Rs=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,Es="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let Ut;const Ps=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,Bs=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,js=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,Os=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,Fs=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,$s=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,Mn="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",Ls=new RegExp(`^${Mn}$`);function Cn(s){let e="[0-5]\\d";s.precision?e=`${e}\\.\\d{${s.precision}}`:s.precision==null&&(e=`${e}(\\.\\d+)?`);const t=s.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${e})${t}`}function Ds(s){return new RegExp(`^${Cn(s)}$`)}function Us(s){let e=`${Mn}T${Cn(s)}`;const t=[];return t.push(s.local?"Z?":"Z"),s.offset&&t.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${t.join("|")})`,new RegExp(`^${e}$`)}function Ys(s,e){return!!((e==="v4"||!e)&&Ps.test(s)||(e==="v6"||!e)&&js.test(s))}function zs(s,e){if(!Ts.test(s))return!1;try{const[t]=s.split(".");if(!t)return!1;const n=t.replace(/-/g,"+").replace(/_/g,"/").padEnd(t.length+(4-t.length%4)%4,"="),o=JSON.parse(atob(n));return!(typeof o!="object"||o===null||"typ"in o&&(o==null?void 0:o.typ)!=="JWT"||!o.alg||e&&o.alg!==e)}catch{return!1}}function Zs(s,e){return!!((e==="v4"||!e)&&Bs.test(s)||(e==="v6"||!e)&&Os.test(s))}class Te extends ee{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==z.string){const r=this._getOrReturnCtx(e);return U(r,{code:j.invalid_type,expected:z.string,received:r.parsedType}),K}const n=new ge;let o;for(const r of this._def.checks)if(r.kind==="min")e.data.length<r.value&&(o=this._getOrReturnCtx(e,o),U(o,{code:j.too_small,minimum:r.value,type:"string",inclusive:!0,exact:!1,message:r.message}),n.dirty());else if(r.kind==="max")e.data.length>r.value&&(o=this._getOrReturnCtx(e,o),U(o,{code:j.too_big,maximum:r.value,type:"string",inclusive:!0,exact:!1,message:r.message}),n.dirty());else if(r.kind==="length"){const i=e.data.length>r.value,a=e.data.length<r.value;(i||a)&&(o=this._getOrReturnCtx(e,o),i?U(o,{code:j.too_big,maximum:r.value,type:"string",inclusive:!0,exact:!0,message:r.message}):a&&U(o,{code:j.too_small,minimum:r.value,type:"string",inclusive:!0,exact:!0,message:r.message}),n.dirty())}else if(r.kind==="email")Rs.test(e.data)||(o=this._getOrReturnCtx(e,o),U(o,{validation:"email",code:j.invalid_string,message:r.message}),n.dirty());else if(r.kind==="emoji")Ut||(Ut=new RegExp(Es,"u")),Ut.test(e.data)||(o=this._getOrReturnCtx(e,o),U(o,{validation:"emoji",code:j.invalid_string,message:r.message}),n.dirty());else if(r.kind==="uuid")Ms.test(e.data)||(o=this._getOrReturnCtx(e,o),U(o,{validation:"uuid",code:j.invalid_string,message:r.message}),n.dirty());else if(r.kind==="nanoid")Cs.test(e.data)||(o=this._getOrReturnCtx(e,o),U(o,{validation:"nanoid",code:j.invalid_string,message:r.message}),n.dirty());else if(r.kind==="cuid")ks.test(e.data)||(o=this._getOrReturnCtx(e,o),U(o,{validation:"cuid",code:j.invalid_string,message:r.message}),n.dirty());else if(r.kind==="cuid2")Ss.test(e.data)||(o=this._getOrReturnCtx(e,o),U(o,{validation:"cuid2",code:j.invalid_string,message:r.message}),n.dirty());else if(r.kind==="ulid")As.test(e.data)||(o=this._getOrReturnCtx(e,o),U(o,{validation:"ulid",code:j.invalid_string,message:r.message}),n.dirty());else if(r.kind==="url")try{new URL(e.data)}catch{o=this._getOrReturnCtx(e,o),U(o,{validation:"url",code:j.invalid_string,message:r.message}),n.dirty()}else r.kind==="regex"?(r.regex.lastIndex=0,r.regex.test(e.data)||(o=this._getOrReturnCtx(e,o),U(o,{validation:"regex",code:j.invalid_string,message:r.message}),n.dirty())):r.kind==="trim"?e.data=e.data.trim():r.kind==="includes"?e.data.includes(r.value,r.position)||(o=this._getOrReturnCtx(e,o),U(o,{code:j.invalid_string,validation:{includes:r.value,position:r.position},message:r.message}),n.dirty()):r.kind==="toLowerCase"?e.data=e.data.toLowerCase():r.kind==="toUpperCase"?e.data=e.data.toUpperCase():r.kind==="startsWith"?e.data.startsWith(r.value)||(o=this._getOrReturnCtx(e,o),U(o,{code:j.invalid_string,validation:{startsWith:r.value},message:r.message}),n.dirty()):r.kind==="endsWith"?e.data.endsWith(r.value)||(o=this._getOrReturnCtx(e,o),U(o,{code:j.invalid_string,validation:{endsWith:r.value},message:r.message}),n.dirty()):r.kind==="datetime"?Us(r).test(e.data)||(o=this._getOrReturnCtx(e,o),U(o,{code:j.invalid_string,validation:"datetime",message:r.message}),n.dirty()):r.kind==="date"?Ls.test(e.data)||(o=this._getOrReturnCtx(e,o),U(o,{code:j.invalid_string,validation:"date",message:r.message}),n.dirty()):r.kind==="time"?Ds(r).test(e.data)||(o=this._getOrReturnCtx(e,o),U(o,{code:j.invalid_string,validation:"time",message:r.message}),n.dirty()):r.kind==="duration"?Ns.test(e.data)||(o=this._getOrReturnCtx(e,o),U(o,{validation:"duration",code:j.invalid_string,message:r.message}),n.dirty()):r.kind==="ip"?Ys(e.data,r.version)||(o=this._getOrReturnCtx(e,o),U(o,{validation:"ip",code:j.invalid_string,message:r.message}),n.dirty()):r.kind==="jwt"?zs(e.data,r.alg)||(o=this._getOrReturnCtx(e,o),U(o,{validation:"jwt",code:j.invalid_string,message:r.message}),n.dirty()):r.kind==="cidr"?Zs(e.data,r.version)||(o=this._getOrReturnCtx(e,o),U(o,{validation:"cidr",code:j.invalid_string,message:r.message}),n.dirty()):r.kind==="base64"?Fs.test(e.data)||(o=this._getOrReturnCtx(e,o),U(o,{validation:"base64",code:j.invalid_string,message:r.message}),n.dirty()):r.kind==="base64url"?$s.test(e.data)||(o=this._getOrReturnCtx(e,o),U(o,{validation:"base64url",code:j.invalid_string,message:r.message}),n.dirty()):ne.assertNever(r);return{status:n.value,value:e.data}}_regex(e,t,n){return this.refinement(o=>e.test(o),{validation:t,code:j.invalid_string,...Z.errToObj(n)})}_addCheck(e){return new Te({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...Z.errToObj(e)})}url(e){return this._addCheck({kind:"url",...Z.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...Z.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...Z.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...Z.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...Z.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...Z.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...Z.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...Z.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...Z.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...Z.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...Z.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...Z.errToObj(e)})}datetime(e){return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,offset:(e==null?void 0:e.offset)??!1,local:(e==null?void 0:e.local)??!1,...Z.errToObj(e==null?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,...Z.errToObj(e==null?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...Z.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...Z.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t==null?void 0:t.position,...Z.errToObj(t==null?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...Z.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...Z.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...Z.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...Z.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...Z.errToObj(t)})}nonempty(e){return this.min(1,Z.errToObj(e))}trim(){return new Te({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new Te({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new Te({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}Te.create=s=>new Te({checks:[],typeName:V.ZodString,coerce:(s==null?void 0:s.coerce)??!1,...G(s)});function Xs(s,e){const t=(s.toString().split(".")[1]||"").length,n=(e.toString().split(".")[1]||"").length,o=t>n?t:n,r=Number.parseInt(s.toFixed(o).replace(".","")),i=Number.parseInt(e.toFixed(o).replace(".",""));return r%i/10**o}class Fe extends ee{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==z.number){const r=this._getOrReturnCtx(e);return U(r,{code:j.invalid_type,expected:z.number,received:r.parsedType}),K}let n;const o=new ge;for(const r of this._def.checks)r.kind==="int"?ne.isInteger(e.data)||(n=this._getOrReturnCtx(e,n),U(n,{code:j.invalid_type,expected:"integer",received:"float",message:r.message}),o.dirty()):r.kind==="min"?(r.inclusive?e.data<r.value:e.data<=r.value)&&(n=this._getOrReturnCtx(e,n),U(n,{code:j.too_small,minimum:r.value,type:"number",inclusive:r.inclusive,exact:!1,message:r.message}),o.dirty()):r.kind==="max"?(r.inclusive?e.data>r.value:e.data>=r.value)&&(n=this._getOrReturnCtx(e,n),U(n,{code:j.too_big,maximum:r.value,type:"number",inclusive:r.inclusive,exact:!1,message:r.message}),o.dirty()):r.kind==="multipleOf"?Xs(e.data,r.value)!==0&&(n=this._getOrReturnCtx(e,n),U(n,{code:j.not_multiple_of,multipleOf:r.value,message:r.message}),o.dirty()):r.kind==="finite"?Number.isFinite(e.data)||(n=this._getOrReturnCtx(e,n),U(n,{code:j.not_finite,message:r.message}),o.dirty()):ne.assertNever(r);return{status:o.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,Z.toString(t))}gt(e,t){return this.setLimit("min",e,!1,Z.toString(t))}lte(e,t){return this.setLimit("max",e,!0,Z.toString(t))}lt(e,t){return this.setLimit("max",e,!1,Z.toString(t))}setLimit(e,t,n,o){return new Fe({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:Z.toString(o)}]})}_addCheck(e){return new Fe({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:Z.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:Z.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:Z.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:Z.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:Z.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:Z.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:Z.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:Z.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:Z.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&ne.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const n of this._def.checks){if(n.kind==="finite"||n.kind==="int"||n.kind==="multipleOf")return!0;n.kind==="min"?(t===null||n.value>t)&&(t=n.value):n.kind==="max"&&(e===null||n.value<e)&&(e=n.value)}return Number.isFinite(t)&&Number.isFinite(e)}}Fe.create=s=>new Fe({checks:[],typeName:V.ZodNumber,coerce:(s==null?void 0:s.coerce)||!1,...G(s)});class $e extends ee{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==z.bigint)return this._getInvalidInput(e);let n;const o=new ge;for(const r of this._def.checks)r.kind==="min"?(r.inclusive?e.data<r.value:e.data<=r.value)&&(n=this._getOrReturnCtx(e,n),U(n,{code:j.too_small,type:"bigint",minimum:r.value,inclusive:r.inclusive,message:r.message}),o.dirty()):r.kind==="max"?(r.inclusive?e.data>r.value:e.data>=r.value)&&(n=this._getOrReturnCtx(e,n),U(n,{code:j.too_big,type:"bigint",maximum:r.value,inclusive:r.inclusive,message:r.message}),o.dirty()):r.kind==="multipleOf"?e.data%r.value!==BigInt(0)&&(n=this._getOrReturnCtx(e,n),U(n,{code:j.not_multiple_of,multipleOf:r.value,message:r.message}),o.dirty()):ne.assertNever(r);return{status:o.value,value:e.data}}_getInvalidInput(e){const t=this._getOrReturnCtx(e);return U(t,{code:j.invalid_type,expected:z.bigint,received:t.parsedType}),K}gte(e,t){return this.setLimit("min",e,!0,Z.toString(t))}gt(e,t){return this.setLimit("min",e,!1,Z.toString(t))}lte(e,t){return this.setLimit("max",e,!0,Z.toString(t))}lt(e,t){return this.setLimit("max",e,!1,Z.toString(t))}setLimit(e,t,n,o){return new $e({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:Z.toString(o)}]})}_addCheck(e){return new $e({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:Z.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:Z.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:Z.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:Z.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:Z.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}}$e.create=s=>new $e({checks:[],typeName:V.ZodBigInt,coerce:(s==null?void 0:s.coerce)??!1,...G(s)});class bt extends ee{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==z.boolean){const n=this._getOrReturnCtx(e);return U(n,{code:j.invalid_type,expected:z.boolean,received:n.parsedType}),K}return Ie(e.data)}}bt.create=s=>new bt({typeName:V.ZodBoolean,coerce:(s==null?void 0:s.coerce)||!1,...G(s)});class Xe extends ee{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==z.date){const r=this._getOrReturnCtx(e);return U(r,{code:j.invalid_type,expected:z.date,received:r.parsedType}),K}if(Number.isNaN(e.data.getTime())){const r=this._getOrReturnCtx(e);return U(r,{code:j.invalid_date}),K}const n=new ge;let o;for(const r of this._def.checks)r.kind==="min"?e.data.getTime()<r.value&&(o=this._getOrReturnCtx(e,o),U(o,{code:j.too_small,message:r.message,inclusive:!0,exact:!1,minimum:r.value,type:"date"}),n.dirty()):r.kind==="max"?e.data.getTime()>r.value&&(o=this._getOrReturnCtx(e,o),U(o,{code:j.too_big,message:r.message,inclusive:!0,exact:!1,maximum:r.value,type:"date"}),n.dirty()):ne.assertNever(r);return{status:n.value,value:new Date(e.data.getTime())}}_addCheck(e){return new Xe({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:Z.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:Z.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}}Xe.create=s=>new Xe({checks:[],coerce:(s==null?void 0:s.coerce)||!1,typeName:V.ZodDate,...G(s)});class Tn extends ee{_parse(e){if(this._getType(e)!==z.symbol){const n=this._getOrReturnCtx(e);return U(n,{code:j.invalid_type,expected:z.symbol,received:n.parsedType}),K}return Ie(e.data)}}Tn.create=s=>new Tn({typeName:V.ZodSymbol,...G(s)});class Nn extends ee{_parse(e){if(this._getType(e)!==z.undefined){const n=this._getOrReturnCtx(e);return U(n,{code:j.invalid_type,expected:z.undefined,received:n.parsedType}),K}return Ie(e.data)}}Nn.create=s=>new Nn({typeName:V.ZodUndefined,...G(s)});class Rn extends ee{_parse(e){if(this._getType(e)!==z.null){const n=this._getOrReturnCtx(e);return U(n,{code:j.invalid_type,expected:z.null,received:n.parsedType}),K}return Ie(e.data)}}Rn.create=s=>new Rn({typeName:V.ZodNull,...G(s)});class Yt extends ee{constructor(){super(...arguments),this._any=!0}_parse(e){return Ie(e.data)}}Yt.create=s=>new Yt({typeName:V.ZodAny,...G(s)});class En extends ee{constructor(){super(...arguments),this._unknown=!0}_parse(e){return Ie(e.data)}}En.create=s=>new En({typeName:V.ZodUnknown,...G(s)});class Be extends ee{_parse(e){const t=this._getOrReturnCtx(e);return U(t,{code:j.invalid_type,expected:z.never,received:t.parsedType}),K}}Be.create=s=>new Be({typeName:V.ZodNever,...G(s)});class Pn extends ee{_parse(e){if(this._getType(e)!==z.undefined){const n=this._getOrReturnCtx(e);return U(n,{code:j.invalid_type,expected:z.void,received:n.parsedType}),K}return Ie(e.data)}}Pn.create=s=>new Pn({typeName:V.ZodVoid,...G(s)});class Ne extends ee{_parse(e){const{ctx:t,status:n}=this._processInputParams(e),o=this._def;if(t.parsedType!==z.array)return U(t,{code:j.invalid_type,expected:z.array,received:t.parsedType}),K;if(o.exactLength!==null){const i=t.data.length>o.exactLength.value,a=t.data.length<o.exactLength.value;(i||a)&&(U(t,{code:i?j.too_big:j.too_small,minimum:a?o.exactLength.value:void 0,maximum:i?o.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:o.exactLength.message}),n.dirty())}if(o.minLength!==null&&t.data.length<o.minLength.value&&(U(t,{code:j.too_small,minimum:o.minLength.value,type:"array",inclusive:!0,exact:!1,message:o.minLength.message}),n.dirty()),o.maxLength!==null&&t.data.length>o.maxLength.value&&(U(t,{code:j.too_big,maximum:o.maxLength.value,type:"array",inclusive:!0,exact:!1,message:o.maxLength.message}),n.dirty()),t.common.async)return Promise.all([...t.data].map((i,a)=>o.type._parseAsync(new Ce(t,i,t.path,a)))).then(i=>ge.mergeArray(n,i));const r=[...t.data].map((i,a)=>o.type._parseSync(new Ce(t,i,t.path,a)));return ge.mergeArray(n,r)}get element(){return this._def.type}min(e,t){return new Ne({...this._def,minLength:{value:e,message:Z.toString(t)}})}max(e,t){return new Ne({...this._def,maxLength:{value:e,message:Z.toString(t)}})}length(e,t){return new Ne({...this._def,exactLength:{value:e,message:Z.toString(t)}})}nonempty(e){return this.min(1,e)}}Ne.create=(s,e)=>new Ne({type:s,minLength:null,maxLength:null,exactLength:null,typeName:V.ZodArray,...G(e)});function qe(s){if(s instanceof he){const e={};for(const t in s.shape){const n=s.shape[t];e[t]=je.create(qe(n))}return new he({...s._def,shape:()=>e})}else return s instanceof Ne?new Ne({...s._def,type:qe(s.element)}):s instanceof je?je.create(qe(s.unwrap())):s instanceof He?He.create(qe(s.unwrap())):s instanceof Le?Le.create(s.items.map(e=>qe(e))):s}class he extends ee{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),t=ne.objectKeys(e);return this._cached={shape:e,keys:t},this._cached}_parse(e){if(this._getType(e)!==z.object){const d=this._getOrReturnCtx(e);return U(d,{code:j.invalid_type,expected:z.object,received:d.parsedType}),K}const{status:n,ctx:o}=this._processInputParams(e),{shape:r,keys:i}=this._getCached(),a=[];if(!(this._def.catchall instanceof Be&&this._def.unknownKeys==="strip"))for(const d in o.data)i.includes(d)||a.push(d);const c=[];for(const d of i){const l=r[d],u=o.data[d];c.push({key:{status:"valid",value:d},value:l._parse(new Ce(o,u,o.path,d)),alwaysSet:d in o.data})}if(this._def.catchall instanceof Be){const d=this._def.unknownKeys;if(d==="passthrough")for(const l of a)c.push({key:{status:"valid",value:l},value:{status:"valid",value:o.data[l]}});else if(d==="strict")a.length>0&&(U(o,{code:j.unrecognized_keys,keys:a}),n.dirty());else if(d!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const d=this._def.catchall;for(const l of a){const u=o.data[l];c.push({key:{status:"valid",value:l},value:d._parse(new Ce(o,u,o.path,l)),alwaysSet:l in o.data})}}return o.common.async?Promise.resolve().then(async()=>{const d=[];for(const l of c){const u=await l.key,f=await l.value;d.push({key:u,value:f,alwaysSet:l.alwaysSet})}return d}).then(d=>ge.mergeObjectSync(n,d)):ge.mergeObjectSync(n,c)}get shape(){return this._def.shape()}strict(e){return Z.errToObj,new he({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(t,n)=>{var r,i;const o=((i=(r=this._def).errorMap)==null?void 0:i.call(r,t,n).message)??n.defaultError;return t.code==="unrecognized_keys"?{message:Z.errToObj(e).message??o}:{message:o}}}:{}})}strip(){return new he({...this._def,unknownKeys:"strip"})}passthrough(){return new he({...this._def,unknownKeys:"passthrough"})}extend(e){return new he({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new he({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:V.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new he({...this._def,catchall:e})}pick(e){const t={};for(const n of ne.objectKeys(e))e[n]&&this.shape[n]&&(t[n]=this.shape[n]);return new he({...this._def,shape:()=>t})}omit(e){const t={};for(const n of ne.objectKeys(this.shape))e[n]||(t[n]=this.shape[n]);return new he({...this._def,shape:()=>t})}deepPartial(){return qe(this)}partial(e){const t={};for(const n of ne.objectKeys(this.shape)){const o=this.shape[n];e&&!e[n]?t[n]=o:t[n]=o.optional()}return new he({...this._def,shape:()=>t})}required(e){const t={};for(const n of ne.objectKeys(this.shape))if(e&&!e[n])t[n]=this.shape[n];else{let r=this.shape[n];for(;r instanceof je;)r=r._def.innerType;t[n]=r}return new he({...this._def,shape:()=>t})}keyof(){return On(ne.objectKeys(this.shape))}}he.create=(s,e)=>new he({shape:()=>s,unknownKeys:"strip",catchall:Be.create(),typeName:V.ZodObject,...G(e)}),he.strictCreate=(s,e)=>new he({shape:()=>s,unknownKeys:"strict",catchall:Be.create(),typeName:V.ZodObject,...G(e)}),he.lazycreate=(s,e)=>new he({shape:s,unknownKeys:"strip",catchall:Be.create(),typeName:V.ZodObject,...G(e)});class vt extends ee{_parse(e){const{ctx:t}=this._processInputParams(e),n=this._def.options;function o(r){for(const a of r)if(a.result.status==="valid")return a.result;for(const a of r)if(a.result.status==="dirty")return t.common.issues.push(...a.ctx.common.issues),a.result;const i=r.map(a=>new Re(a.ctx.common.issues));return U(t,{code:j.invalid_union,unionErrors:i}),K}if(t.common.async)return Promise.all(n.map(async r=>{const i={...t,common:{...t.common,issues:[]},parent:null};return{result:await r._parseAsync({data:t.data,path:t.path,parent:i}),ctx:i}})).then(o);{let r;const i=[];for(const c of n){const d={...t,common:{...t.common,issues:[]},parent:null},l=c._parseSync({data:t.data,path:t.path,parent:d});if(l.status==="valid")return l;l.status==="dirty"&&!r&&(r={result:l,ctx:d}),d.common.issues.length&&i.push(d.common.issues)}if(r)return t.common.issues.push(...r.ctx.common.issues),r.result;const a=i.map(c=>new Re(c));return U(t,{code:j.invalid_union,unionErrors:a}),K}}get options(){return this._def.options}}vt.create=(s,e)=>new vt({options:s,typeName:V.ZodUnion,...G(e)});function zt(s,e){const t=Pe(s),n=Pe(e);if(s===e)return{valid:!0,data:s};if(t===z.object&&n===z.object){const o=ne.objectKeys(e),r=ne.objectKeys(s).filter(a=>o.indexOf(a)!==-1),i={...s,...e};for(const a of r){const c=zt(s[a],e[a]);if(!c.valid)return{valid:!1};i[a]=c.data}return{valid:!0,data:i}}else if(t===z.array&&n===z.array){if(s.length!==e.length)return{valid:!1};const o=[];for(let r=0;r<s.length;r++){const i=s[r],a=e[r],c=zt(i,a);if(!c.valid)return{valid:!1};o.push(c.data)}return{valid:!0,data:o}}else return t===z.date&&n===z.date&&+s==+e?{valid:!0,data:s}:{valid:!1}}class wt extends ee{_parse(e){const{status:t,ctx:n}=this._processInputParams(e),o=(r,i)=>{if(kn(r)||kn(i))return K;const a=zt(r.value,i.value);return a.valid?((Sn(r)||Sn(i))&&t.dirty(),{status:t.value,value:a.data}):(U(n,{code:j.invalid_intersection_types}),K)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then(([r,i])=>o(r,i)):o(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}}wt.create=(s,e,t)=>new wt({left:s,right:e,typeName:V.ZodIntersection,...G(t)});class Le extends ee{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==z.array)return U(n,{code:j.invalid_type,expected:z.array,received:n.parsedType}),K;if(n.data.length<this._def.items.length)return U(n,{code:j.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),K;!this._def.rest&&n.data.length>this._def.items.length&&(U(n,{code:j.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const r=[...n.data].map((i,a)=>{const c=this._def.items[a]||this._def.rest;return c?c._parse(new Ce(n,i,n.path,a)):null}).filter(i=>!!i);return n.common.async?Promise.all(r).then(i=>ge.mergeArray(t,i)):ge.mergeArray(t,r)}get items(){return this._def.items}rest(e){return new Le({...this._def,rest:e})}}Le.create=(s,e)=>{if(!Array.isArray(s))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Le({items:s,typeName:V.ZodTuple,rest:null,...G(e)})};class kt extends ee{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==z.object)return U(n,{code:j.invalid_type,expected:z.object,received:n.parsedType}),K;const o=[],r=this._def.keyType,i=this._def.valueType;for(const a in n.data)o.push({key:r._parse(new Ce(n,a,n.path,a)),value:i._parse(new Ce(n,n.data[a],n.path,a)),alwaysSet:a in n.data});return n.common.async?ge.mergeObjectAsync(t,o):ge.mergeObjectSync(t,o)}get element(){return this._def.valueType}static create(e,t,n){return t instanceof ee?new kt({keyType:e,valueType:t,typeName:V.ZodRecord,...G(n)}):new kt({keyType:Te.create(),valueType:e,typeName:V.ZodRecord,...G(t)})}}class Bn extends ee{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==z.map)return U(n,{code:j.invalid_type,expected:z.map,received:n.parsedType}),K;const o=this._def.keyType,r=this._def.valueType,i=[...n.data.entries()].map(([a,c],d)=>({key:o._parse(new Ce(n,a,n.path,[d,"key"])),value:r._parse(new Ce(n,c,n.path,[d,"value"]))}));if(n.common.async){const a=new Map;return Promise.resolve().then(async()=>{for(const c of i){const d=await c.key,l=await c.value;if(d.status==="aborted"||l.status==="aborted")return K;(d.status==="dirty"||l.status==="dirty")&&t.dirty(),a.set(d.value,l.value)}return{status:t.value,value:a}})}else{const a=new Map;for(const c of i){const d=c.key,l=c.value;if(d.status==="aborted"||l.status==="aborted")return K;(d.status==="dirty"||l.status==="dirty")&&t.dirty(),a.set(d.value,l.value)}return{status:t.value,value:a}}}}Bn.create=(s,e,t)=>new Bn({valueType:e,keyType:s,typeName:V.ZodMap,...G(t)});class dt extends ee{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==z.set)return U(n,{code:j.invalid_type,expected:z.set,received:n.parsedType}),K;const o=this._def;o.minSize!==null&&n.data.size<o.minSize.value&&(U(n,{code:j.too_small,minimum:o.minSize.value,type:"set",inclusive:!0,exact:!1,message:o.minSize.message}),t.dirty()),o.maxSize!==null&&n.data.size>o.maxSize.value&&(U(n,{code:j.too_big,maximum:o.maxSize.value,type:"set",inclusive:!0,exact:!1,message:o.maxSize.message}),t.dirty());const r=this._def.valueType;function i(c){const d=new Set;for(const l of c){if(l.status==="aborted")return K;l.status==="dirty"&&t.dirty(),d.add(l.value)}return{status:t.value,value:d}}const a=[...n.data.values()].map((c,d)=>r._parse(new Ce(n,c,n.path,d)));return n.common.async?Promise.all(a).then(c=>i(c)):i(a)}min(e,t){return new dt({...this._def,minSize:{value:e,message:Z.toString(t)}})}max(e,t){return new dt({...this._def,maxSize:{value:e,message:Z.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}dt.create=(s,e)=>new dt({valueType:s,minSize:null,maxSize:null,typeName:V.ZodSet,...G(e)});class jn extends ee{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}jn.create=(s,e)=>new jn({getter:s,typeName:V.ZodLazy,...G(e)});class Zt extends ee{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return U(t,{received:t.data,code:j.invalid_literal,expected:this._def.value}),K}return{status:"valid",value:e.data}}get value(){return this._def.value}}Zt.create=(s,e)=>new Zt({value:s,typeName:V.ZodLiteral,...G(e)});function On(s,e){return new Ve({values:s,typeName:V.ZodEnum,...G(e)})}class Ve extends ee{_parse(e){if(typeof e.data!="string"){const t=this._getOrReturnCtx(e),n=this._def.values;return U(t,{expected:ne.joinValues(n),received:t.parsedType,code:j.invalid_type}),K}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){const t=this._getOrReturnCtx(e),n=this._def.values;return U(t,{received:t.data,code:j.invalid_enum_value,options:n}),K}return Ie(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return Ve.create(e,{...this._def,...t})}exclude(e,t=this._def){return Ve.create(this.options.filter(n=>!e.includes(n)),{...this._def,...t})}}Ve.create=On;class Fn extends ee{_parse(e){const t=ne.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(e);if(n.parsedType!==z.string&&n.parsedType!==z.number){const o=ne.objectValues(t);return U(n,{expected:ne.joinValues(o),received:n.parsedType,code:j.invalid_type}),K}if(this._cache||(this._cache=new Set(ne.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){const o=ne.objectValues(t);return U(n,{received:n.data,code:j.invalid_enum_value,options:o}),K}return Ie(e.data)}get enum(){return this._def.values}}Fn.create=(s,e)=>new Fn({values:s,typeName:V.ZodNativeEnum,...G(e)});class St extends ee{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==z.promise&&t.common.async===!1)return U(t,{code:j.invalid_type,expected:z.promise,received:t.parsedType}),K;const n=t.parsedType===z.promise?t.data:Promise.resolve(t.data);return Ie(n.then(o=>this._def.type.parseAsync(o,{path:t.path,errorMap:t.common.contextualErrorMap})))}}St.create=(s,e)=>new St({type:s,typeName:V.ZodPromise,...G(e)});class Ke extends ee{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===V.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:n}=this._processInputParams(e),o=this._def.effect||null,r={addIssue:i=>{U(n,i),i.fatal?t.abort():t.dirty()},get path(){return n.path}};if(r.addIssue=r.addIssue.bind(r),o.type==="preprocess"){const i=o.transform(n.data,r);if(n.common.async)return Promise.resolve(i).then(async a=>{if(t.value==="aborted")return K;const c=await this._def.schema._parseAsync({data:a,path:n.path,parent:n});return c.status==="aborted"?K:c.status==="dirty"||t.value==="dirty"?ct(c.value):c});{if(t.value==="aborted")return K;const a=this._def.schema._parseSync({data:i,path:n.path,parent:n});return a.status==="aborted"?K:a.status==="dirty"||t.value==="dirty"?ct(a.value):a}}if(o.type==="refinement"){const i=a=>{const c=o.refinement(a,r);if(n.common.async)return Promise.resolve(c);if(c instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return a};if(n.common.async===!1){const a=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});return a.status==="aborted"?K:(a.status==="dirty"&&t.dirty(),i(a.value),{status:t.value,value:a.value})}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(a=>a.status==="aborted"?K:(a.status==="dirty"&&t.dirty(),i(a.value).then(()=>({status:t.value,value:a.value}))))}if(o.type==="transform")if(n.common.async===!1){const i=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!Ze(i))return K;const a=o.transform(i.value,r);if(a instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:a}}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(i=>Ze(i)?Promise.resolve(o.transform(i.value,r)).then(a=>({status:t.value,value:a})):K);ne.assertNever(o)}}Ke.create=(s,e,t)=>new Ke({schema:s,typeName:V.ZodEffects,effect:e,...G(t)}),Ke.createWithPreprocess=(s,e,t)=>new Ke({schema:e,effect:{type:"preprocess",transform:s},typeName:V.ZodEffects,...G(t)});class je extends ee{_parse(e){return this._getType(e)===z.undefined?Ie(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}je.create=(s,e)=>new je({innerType:s,typeName:V.ZodOptional,...G(e)});class He extends ee{_parse(e){return this._getType(e)===z.null?Ie(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}He.create=(s,e)=>new He({innerType:s,typeName:V.ZodNullable,...G(e)});class Xt extends ee{_parse(e){const{ctx:t}=this._processInputParams(e);let n=t.data;return t.parsedType===z.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}Xt.create=(s,e)=>new Xt({innerType:s,typeName:V.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...G(e)});class qt extends ee{_parse(e){const{ctx:t}=this._processInputParams(e),n={...t,common:{...t.common,issues:[]}},o=this._def.innerType._parse({data:n.data,path:n.path,parent:{...n}});return It(o)?o.then(r=>({status:"valid",value:r.status==="valid"?r.value:this._def.catchValue({get error(){return new Re(n.common.issues)},input:n.data})})):{status:"valid",value:o.status==="valid"?o.value:this._def.catchValue({get error(){return new Re(n.common.issues)},input:n.data})}}removeCatch(){return this._def.innerType}}qt.create=(s,e)=>new qt({innerType:s,typeName:V.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...G(e)});class $n extends ee{_parse(e){if(this._getType(e)!==z.nan){const n=this._getOrReturnCtx(e);return U(n,{code:j.invalid_type,expected:z.nan,received:n.parsedType}),K}return{status:"valid",value:e.data}}}$n.create=s=>new $n({typeName:V.ZodNaN,...G(s)});class qs extends ee{_parse(e){const{ctx:t}=this._processInputParams(e),n=t.data;return this._def.type._parse({data:n,path:t.path,parent:t})}unwrap(){return this._def.type}}class Vt extends ee{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.common.async)return(async()=>{const r=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return r.status==="aborted"?K:r.status==="dirty"?(t.dirty(),ct(r.value)):this._def.out._parseAsync({data:r.value,path:n.path,parent:n})})();{const o=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return o.status==="aborted"?K:o.status==="dirty"?(t.dirty(),{status:"dirty",value:o.value}):this._def.out._parseSync({data:o.value,path:n.path,parent:n})}}static create(e,t){return new Vt({in:e,out:t,typeName:V.ZodPipeline})}}class Kt extends ee{_parse(e){const t=this._def.innerType._parse(e),n=o=>(Ze(o)&&(o.value=Object.freeze(o.value)),o);return It(t)?t.then(o=>n(o)):n(t)}unwrap(){return this._def.innerType}}Kt.create=(s,e)=>new Kt({innerType:s,typeName:V.ZodReadonly,...G(e)});var V;(function(s){s.ZodString="ZodString",s.ZodNumber="ZodNumber",s.ZodNaN="ZodNaN",s.ZodBigInt="ZodBigInt",s.ZodBoolean="ZodBoolean",s.ZodDate="ZodDate",s.ZodSymbol="ZodSymbol",s.ZodUndefined="ZodUndefined",s.ZodNull="ZodNull",s.ZodAny="ZodAny",s.ZodUnknown="ZodUnknown",s.ZodNever="ZodNever",s.ZodVoid="ZodVoid",s.ZodArray="ZodArray",s.ZodObject="ZodObject",s.ZodUnion="ZodUnion",s.ZodDiscriminatedUnion="ZodDiscriminatedUnion",s.ZodIntersection="ZodIntersection",s.ZodTuple="ZodTuple",s.ZodRecord="ZodRecord",s.ZodMap="ZodMap",s.ZodSet="ZodSet",s.ZodFunction="ZodFunction",s.ZodLazy="ZodLazy",s.ZodLiteral="ZodLiteral",s.ZodEnum="ZodEnum",s.ZodEffects="ZodEffects",s.ZodNativeEnum="ZodNativeEnum",s.ZodOptional="ZodOptional",s.ZodNullable="ZodNullable",s.ZodDefault="ZodDefault",s.ZodCatch="ZodCatch",s.ZodPromise="ZodPromise",s.ZodBranded="ZodBranded",s.ZodPipeline="ZodPipeline",s.ZodReadonly="ZodReadonly"})(V||(V={}));const re=Te.create,le=Fe.create;$e.create;const We=bt.create;Xe.create;const Vs=Yt.create;Be.create;const ve=Ne.create,xe=he.create,Ks=vt.create;wt.create;const Ln=Le.create,we=kt.create,Ht=Zt.create,Dn=Ve.create;St.create,je.create,He.create;const ke={string:(s=>Te.create({...s,coerce:!0})),number:(s=>Fe.create({...s,coerce:!0})),boolean:(s=>bt.create({...s,coerce:!0})),bigint:(s=>$e.create({...s,coerce:!0})),date:(s=>Xe.create({...s,coerce:!0}))},Hs=Dn(["low","medium","high"]).catch("medium");xe({event_id:re(),event_sequence:le().int().nonnegative().catch(-1),timestamp:re(),action:re(),treaty_type:re(),from_alliance_id:le(),from_alliance_name:re().nullish().transform(s=>s??""),to_alliance_id:le(),to_alliance_name:re().nullish().transform(s=>s??""),pair_min_id:le(),pair_max_id:le(),source:re().nullish().default("unknown"),source_ref:re().nullish().default(""),confidence:Hs,inferred:We(),inference_reason:re().nullable(),time_remaining_turns:le().nullable(),grounded_from:We().catch(!1),grounded_to:We().catch(!1),grounded_keep:We().catch(!0),noise_filtered:We().catch(!1),noise_reason:re().nullish().transform(s=>s??null)}),xe({generated_at:re(),parameters:we(Ks([re(),le(),We()])),events_total:le(),flags_total:le(),counts_by_action:we(le()),counts_by_type:we(le()),counts_by_source:we(le())}),we(Vs());const Ws=Dn(["initial","created","changed"]),Gs=xe({timestamp:re(),action:Ws,alliance_id:le(),alliance_name:re().nullish().transform(s=>s??""),flag_key:re().nullish().transform(s=>s??""),previous_flag_key:re().nullish().transform(s=>s??""),source_ref:re().nullish().transform(s=>s??"")});xe({events:ve(Gs)});const Qs=xe({x:le(),y:le(),w:le(),h:le(),hash:re().nullish().transform(s=>s??"")});xe({atlas:xe({webp:re(),png:re().nullish().transform(s=>s??""),width:le(),height:le(),tile_width:le(),tile_height:le()}),assets:we(Qs)}),xe({generatedAt:re(),datasetId:re(),files:we(xe({sizeBytes:le(),sha256:re()}))});const Js=re().regex(/^\d{4}-\d{2}-\d{2}$/),eo=Ln([ke.number().int().positive(),ke.number().int().nonnegative()]),to=we(ke.number().int().positive());xe({schema_version:Ht(2),quantization_scale:ke.number().int().positive(),day_keys:ve(Js),days:ve(ve(eo))}),xe({schema_version:Ht(2),ranks_by_day:we(to)});const Un=re().regex(/^\d{4}-\d{2}-\d{2}$/),no=Ln([ke.number().int().nonnegative(),ke.number().int().positive(),ke.number().int().positive(),re()]),so=xe({add_edge_ids:ve(ke.number().int().nonnegative()),remove_edge_ids:ve(ke.number().int().nonnegative())}),oo=we(Un,ve(ke.number().int().positive())),ro=xe({schema_version:Ht(1),day_keys:ve(Un),event_end_offset_by_day:ve(ke.number().int().nonnegative()),edge_dict:ve(no),active_edge_delta_by_day:ve(so),top_membership_by_day:we(oo)});function io(s){return s.endsWith("/")?s:`${s}/`}function ao(s){const e=io("/treaty-vis/"),t=s.startsWith("/")?s.slice(1):s;return`${e}${t}`}function Oe(s){return ao(`data/${s}`)}function Yn(s){return s.length>=10?s.slice(0,10):s}function zn(s,e){if(s.length===0)return null;if(!e)return s[s.length-1]??null;const t=Yn(e);let n=0,o=s.length-1,r=-1;for(;n<=o;){const i=Math.floor((n+o)/2);s[i]<=t?(r=i,n=i+1):o=i-1}return r>=0?s[r]??null:s[0]??null}function co(s){const e=new Map;return t=>{const n=Yn(t);if(e.has(n))return e.get(n)??null;const o=zn(s,n);return e.set(n,o),o}}const lo=new Set(["cancelled","expired","ended","terminated","termination","inferred_cancelled"]);function Zn(s){const e=new Set;for(const t of s)for(const n of t)e.add(n);return[...e].sort((t,n)=>t-n)}function uo(s,e){let t=0,n=0;const o=[];for(;t<s.length&&n<e.length;){if(s[t]===e[n]){o.push(s[t]),t+=1,n+=1;continue}s[t]<e[n]?t+=1:n+=1}return o}function Wt(s,e){return s.length===0?null:Zn(s.map(t=>e[t]??[]))}function fo(s,e){return s.length===0?null:Zn(s.map(t=>e[String(t)]??[]))}function ho(s,e){let t=0,n=s.length;for(;t<n;){const o=Math.floor((t+n)/2);s[o].timestamp<e?t=o+1:n=o}return t}function Xn(s,e){let t=0,n=s.length;for(;t<n;){const o=Math.floor((t+n)/2);s[o].timestamp<=e?t=o+1:n=o}return t-1}function Gt(s){return`${s.pair_min_id??""}:${s.pair_max_id??""}:${s.treaty_type}`}function mo(s,e){if(!e)return!0;const t=e.toLowerCase();return[s.event_id,s.action,s.treaty_type,s.source||"unknown",s.from_alliance_name||"",s.to_alliance_name||"",String(s.from_alliance_id),String(s.to_alliance_id)].join(" ").toLowerCase().includes(t)}function yo(s,e,t){if(t==="timestamp"){const i=s.timestamp.localeCompare(e.timestamp);if(i!==0)return i}else if(t==="action"){const i=s.action.localeCompare(e.action);if(i!==0)return i}else if(t==="type"){const i=s.treaty_type.localeCompare(e.treaty_type);if(i!==0)return i}else if(t==="from"){const i=(s.from_alliance_name||String(s.from_alliance_id)).localeCompare(e.from_alliance_name||String(e.from_alliance_id));if(i!==0)return i}else if(t==="to"){const i=(s.to_alliance_name||String(s.to_alliance_id)).localeCompare(e.to_alliance_name||String(e.to_alliance_id));if(i!==0)return i}else{const i=(s.source||"unknown").localeCompare(e.source||"unknown");if(i!==0)return i}const n=Number.isFinite(s.event_sequence)?Number(s.event_sequence):Number.POSITIVE_INFINITY,o=Number.isFinite(e.event_sequence)?Number(e.event_sequence):Number.POSITIVE_INFINITY;if(n!==o)return n-o;const r=s.event_id.localeCompare(e.event_id);return r!==0?r:s.timestamp.localeCompare(e.timestamp)}function po(s,e,t,n){const o=n==="asc"?1:-1;return yo(s,e,t)*o}function go(s,e){const t=s.timestamp.localeCompare(e.timestamp);if(t!==0)return t;const n=Number.isFinite(s.event_sequence)?Number(s.event_sequence):Number.POSITIVE_INFINITY,o=Number.isFinite(e.event_sequence)?Number(e.event_sequence):Number.POSITIVE_INFINITY;return n!==o?n-o:s.event_id.localeCompare(e.event_id)}function xo(s,e,t){const n=[...s];return n.sort((o,r)=>po(e[o],e[r],t.sort.field,t.sort.direction)),n}function _o(s,e){const t=Object.keys(s).sort((r,i)=>r.localeCompare(i));if(t.length===0)return null;const n=co(t),o=new Map;return(r,i)=>{const a=n(r);if(!a)return!1;const c=`${a}|${e}`;let d=o.get(c);if(!d){d=new Set;const l=s[a]??{};for(const[u,f]of Object.entries(l)){const y=Number(f);if(!Number.isFinite(y)||y>e)continue;const h=Number(u);Number.isFinite(h)&&d.add(h)}o.set(c,d)}return d.has(i)}}function Io(s){return[s.time.start??"",s.time.end??"",String(s.focus.allianceId??""),s.focus.edgeKey??"",s.focus.eventId??"",s.filters.actions.join(","),s.filters.treatyTypes.join(","),s.filters.sources.join(","),s.filters.alliances.join(","),s.filters.includeInferred?"1":"0",s.filters.includeNoise?"1":"0",s.filters.evidenceMode,String(s.filters.topXByScore??""),s.textQuery.trim().toLowerCase(),s.sort.field,s.sort.direction]}function bo(s){return Io(s).join("|")}function vo(s){const{events:e,indices:t,query:n,topXMembershipLookup:o}=s,r=[t.allEventIndexes],i=Wt(n.filters.actions,t.byAction);i&&r.push(i);const a=Wt(n.filters.treatyTypes,t.byType);a&&r.push(a);const c=Wt(n.filters.sources,t.bySource);c&&r.push(c);const d=fo(n.filters.alliances,t.byAlliance);d&&r.push(d),r.sort((m,p)=>m.length-p.length);let l=r[0]??[];for(let m=1;m<r.length;m+=1)l=uo(l,r[m]);let u=0,f=e.length-1;n.time.start&&(u=ho(e,n.time.start)),n.time.end&&(f=Xn(e,n.time.end)),n.playback.playhead&&(f=Math.min(f,Xn(e,n.playback.playhead)));const y=n.textQuery.trim(),h=l.filter(m=>{if(m<u||m>f)return!1;const p=e[m];return!(o&&(!o(p.timestamp,p.from_alliance_id)||!o(p.timestamp,p.to_alliance_id))||!n.filters.includeInferred&&p.inferred||!n.filters.includeNoise&&p.noise_filtered||n.filters.evidenceMode==="one-confirmed"&&!(p.grounded_from||p.grounded_to)||n.filters.evidenceMode==="both-confirmed"&&!(p.grounded_from&&p.grounded_to)||!mo(p,y)||n.focus.allianceId!==null&&p.from_alliance_id!==n.focus.allianceId&&p.to_alliance_id!==n.focus.allianceId||n.focus.edgeKey&&Gt(p)!==n.focus.edgeKey||n.focus.eventId&&p.event_id!==n.focus.eventId)});return xo(h,e,n)}function wo(s){let e=2166136261;for(let t=0;t<s.length;t+=1)e^=s.charCodeAt(t),e+=(e<<1)+(e<<4)+(e<<7)+(e<<8)+(e<<24);return e>>>0}function qn(s,e){if(s.length<=e)return s;const t=new Uint32Array(s.length),n=new Array(s.length);for(let l=0;l<s.length;l+=1)t[l]=wo(Gt(s[l])),n[l]=s[l].event_id;const o=(l,u)=>{const f=t[l],y=t[u];return f!==y?f>y:n[l]>n[u]},r=[],i=l=>{let u=l;for(;u>0;){const f=Math.floor((u-1)/2);if(!o(r[u],r[f]))break;const y=r[f];r[f]=r[u],r[u]=y,u=f}},a=l=>{let u=l;for(;;){const f=u*2+1,y=f+1;let h=u;if(f<r.length&&o(r[f],r[h])&&(h=f),y<r.length&&o(r[y],r[h])&&(h=y),h===u)break;const m=r[u];r[u]=r[h],r[h]=m,u=h}};for(let l=0;l<s.length;l+=1){if(r.length<e){r.push(l),i(r.length-1);continue}const u=r[0];o(l,u)||(r[0]=l,a(0))}const c=new Set(r),d=[];for(let l=0;l<s.length&&d.length<e;l+=1)c.has(l)&&d.push(s[l]);return d}function ko(s,e,t,n){const o=new Map;for(const c of e){const d=s[c];if(n&&d.timestamp>n)continue;const l=d.timestamp.slice(0,10),u=o.get(l)??{day:l,signed:0,terminal:0,inferred:0};d.action==="signed"&&(u.signed+=1),lo.has(d.action)&&(u.terminal+=1),d.inferred&&(u.inferred+=1),o.set(l,u)}const r=[...o.values()].sort((c,d)=>c.day.localeCompare(d.day));if(r.length<=t)return r;const i=Math.ceil(r.length/t),a=[];for(let c=0;c<r.length;c+=i){const d=r.slice(c,c+i);a.push({day:d[0].day,signed:d.reduce((l,u)=>l+u.signed,0),terminal:d.reduce((l,u)=>l+u.terminal,0),inferred:d.reduce((l,u)=>l+u.inferred,0)})}return a}new TextEncoder;const So=4096;function Vn(s,e,t){let n=e;const o=n+t,r=[];let i="";for(;n<o;){const a=s[n++];if((a&128)===0)r.push(a);else if((a&224)===192){const c=s[n++]&63;r.push((a&31)<<6|c)}else if((a&240)===224){const c=s[n++]&63,d=s[n++]&63;r.push((a&31)<<12|c<<6|d)}else if((a&248)===240){const c=s[n++]&63,d=s[n++]&63,l=s[n++]&63;let u=(a&7)<<18|c<<12|d<<6|l;u>65535&&(u-=65536,r.push(u>>>10&1023|55296),u=56320|u&1023),r.push(u)}else r.push(a);r.length>=So&&(i+=String.fromCharCode(...r),r.length=0)}return r.length>0&&(i+=String.fromCharCode(...r)),i}const Ao=new TextDecoder,Mo=200;function Co(s,e,t){const n=s.subarray(e,e+t);return Ao.decode(n)}function To(s,e,t){return t>Mo?Co(s,e,t):Vn(s,e,t)}class At{constructor(e,t){W(this,"type");W(this,"data");this.type=e,this.data=t}}class _e extends Error{constructor(e){super(e);const t=Object.create(_e.prototype);Object.setPrototypeOf(this,t),Object.defineProperty(this,"name",{configurable:!0,enumerable:!1,value:_e.name})}}const lt=4294967295;function No(s,e,t){const n=Math.floor(t/4294967296),o=t;s.setUint32(e,n),s.setUint32(e+4,o)}function Kn(s,e){const t=s.getInt32(e),n=s.getUint32(e+4);return t*4294967296+n}function Ro(s,e){const t=s.getUint32(e),n=s.getUint32(e+4);return t*4294967296+n}const Eo=-1,Po=4294967296-1,Bo=17179869184-1;function jo({sec:s,nsec:e}){if(s>=0&&e>=0&&s<=Bo)if(e===0&&s<=Po){const t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,s),t}else{const t=s/4294967296,n=s&4294967295,o=new Uint8Array(8),r=new DataView(o.buffer);return r.setUint32(0,e<<2|t&3),r.setUint32(4,n),o}else{const t=new Uint8Array(12),n=new DataView(t.buffer);return n.setUint32(0,e),No(n,4,s),t}}function Oo(s){const e=s.getTime(),t=Math.floor(e/1e3),n=(e-t*1e3)*1e6,o=Math.floor(n/1e9);return{sec:t+o,nsec:n-o*1e9}}function Fo(s){if(s instanceof Date){const e=Oo(s);return jo(e)}else return null}function $o(s){const e=new DataView(s.buffer,s.byteOffset,s.byteLength);switch(s.byteLength){case 4:return{sec:e.getUint32(0),nsec:0};case 8:{const t=e.getUint32(0),n=e.getUint32(4),o=(t&3)*4294967296+n,r=t>>>2;return{sec:o,nsec:r}}case 12:{const t=Kn(e,4),n=e.getUint32(0);return{sec:t,nsec:n}}default:throw new _e(`Unrecognized data size for timestamp (expected 4, 8, or 12): ${s.length}`)}}function Lo(s){const e=$o(s);return new Date(e.sec*1e3+e.nsec/1e6)}const Do={type:Eo,encode:Fo,decode:Lo},Et=class Et{constructor(){W(this,"__brand");W(this,"builtInEncoders",[]);W(this,"builtInDecoders",[]);W(this,"encoders",[]);W(this,"decoders",[]);this.register(Do)}register({type:e,encode:t,decode:n}){if(e>=0)this.encoders[e]=t,this.decoders[e]=n;else{const o=-1-e;this.builtInEncoders[o]=t,this.builtInDecoders[o]=n}}tryToEncode(e,t){for(let n=0;n<this.builtInEncoders.length;n++){const o=this.builtInEncoders[n];if(o!=null){const r=o(e,t);if(r!=null){const i=-1-n;return new At(i,r)}}}for(let n=0;n<this.encoders.length;n++){const o=this.encoders[n];if(o!=null){const r=o(e,t);if(r!=null){const i=n;return new At(i,r)}}}return e instanceof At?e:null}decode(e,t,n){const o=t<0?this.builtInDecoders[-1-t]:this.decoders[t];return o?o(e,t,n):new At(t,e)}};W(Et,"defaultCodec",new Et);let Qt=Et;function Uo(s){return s instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&s instanceof SharedArrayBuffer}function Hn(s){return s instanceof Uint8Array?s:ArrayBuffer.isView(s)?new Uint8Array(s.buffer,s.byteOffset,s.byteLength):Uo(s)?new Uint8Array(s):Uint8Array.from(s)}function Jt(s){return`${s<0?"-":""}0x${Math.abs(s).toString(16).padStart(2,"0")}`}const Yo=16,zo=16;class Zo{constructor(e=Yo,t=zo){W(this,"hit",0);W(this,"miss",0);W(this,"caches");W(this,"maxKeyLength");W(this,"maxLengthPerKey");this.maxKeyLength=e,this.maxLengthPerKey=t,this.caches=[];for(let n=0;n<this.maxKeyLength;n++)this.caches.push([])}canBeCached(e){return e>0&&e<=this.maxKeyLength}find(e,t,n){const o=this.caches[n-1];e:for(const r of o){const i=r.bytes;for(let a=0;a<n;a++)if(i[a]!==e[t+a])continue e;return r.str}return null}store(e,t){const n=this.caches[e.length-1],o={bytes:e,str:t};n.length>=this.maxLengthPerKey?n[Math.random()*n.length|0]=o:n.push(o)}decode(e,t,n){const o=this.find(e,t,n);if(o!=null)return this.hit++,o;this.miss++;const r=Vn(e,t,n),i=Uint8Array.prototype.slice.call(e,t,t+n);return this.store(i,r),r}}const en="array",ut="map_key",Wn="map_value",Xo=s=>{if(typeof s=="string"||typeof s=="number")return s;throw new _e("The type of key must be string or number but "+typeof s)};class qo{constructor(){W(this,"stack",[]);W(this,"stackHeadPosition",-1)}get length(){return this.stackHeadPosition+1}top(){return this.stack[this.stackHeadPosition]}pushArrayState(e){const t=this.getUninitializedStateFromPool();t.type=en,t.position=0,t.size=e,t.array=new Array(e)}pushMapState(e){const t=this.getUninitializedStateFromPool();t.type=ut,t.readCount=0,t.size=e,t.map={}}getUninitializedStateFromPool(){if(this.stackHeadPosition++,this.stackHeadPosition===this.stack.length){const e={type:void 0,size:0,array:void 0,position:0,readCount:0,map:void 0,key:null};this.stack.push(e)}return this.stack[this.stackHeadPosition]}release(e){if(this.stack[this.stackHeadPosition]!==e)throw new Error("Invalid stack state. Released state is not on top of the stack.");if(e.type===en){const n=e;n.size=0,n.array=void 0,n.position=0,n.type=void 0}if(e.type===ut||e.type===Wn){const n=e;n.size=0,n.map=void 0,n.readCount=0,n.type=void 0}this.stackHeadPosition--}reset(){this.stack.length=0,this.stackHeadPosition=-1}}const ft=-1,tn=new DataView(new ArrayBuffer(0)),Vo=new Uint8Array(tn.buffer);try{tn.getInt8(0)}catch(s){if(!(s instanceof RangeError))throw new Error("This module is not supported in the current JavaScript engine because DataView does not throw RangeError on out-of-bounds access")}const Gn=new RangeError("Insufficient data"),Ko=new Zo;class nn{constructor(e){W(this,"extensionCodec");W(this,"context");W(this,"useBigInt64");W(this,"rawStrings");W(this,"maxStrLength");W(this,"maxBinLength");W(this,"maxArrayLength");W(this,"maxMapLength");W(this,"maxExtLength");W(this,"keyDecoder");W(this,"mapKeyConverter");W(this,"totalPos",0);W(this,"pos",0);W(this,"view",tn);W(this,"bytes",Vo);W(this,"headByte",ft);W(this,"stack",new qo);W(this,"entered",!1);this.extensionCodec=(e==null?void 0:e.extensionCodec)??Qt.defaultCodec,this.context=e==null?void 0:e.context,this.useBigInt64=(e==null?void 0:e.useBigInt64)??!1,this.rawStrings=(e==null?void 0:e.rawStrings)??!1,this.maxStrLength=(e==null?void 0:e.maxStrLength)??lt,this.maxBinLength=(e==null?void 0:e.maxBinLength)??lt,this.maxArrayLength=(e==null?void 0:e.maxArrayLength)??lt,this.maxMapLength=(e==null?void 0:e.maxMapLength)??lt,this.maxExtLength=(e==null?void 0:e.maxExtLength)??lt,this.keyDecoder=(e==null?void 0:e.keyDecoder)!==void 0?e.keyDecoder:Ko,this.mapKeyConverter=(e==null?void 0:e.mapKeyConverter)??Xo}clone(){return new nn({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,rawStrings:this.rawStrings,maxStrLength:this.maxStrLength,maxBinLength:this.maxBinLength,maxArrayLength:this.maxArrayLength,maxMapLength:this.maxMapLength,maxExtLength:this.maxExtLength,keyDecoder:this.keyDecoder})}reinitializeState(){this.totalPos=0,this.headByte=ft,this.stack.reset()}setBuffer(e){const t=Hn(e);this.bytes=t,this.view=new DataView(t.buffer,t.byteOffset,t.byteLength),this.pos=0}appendBuffer(e){if(this.headByte===ft&&!this.hasRemaining(1))this.setBuffer(e);else{const t=this.bytes.subarray(this.pos),n=Hn(e),o=new Uint8Array(t.length+n.length);o.set(t),o.set(n,t.length),this.setBuffer(o)}}hasRemaining(e){return this.view.byteLength-this.pos>=e}createExtraByteError(e){const{view:t,pos:n}=this;return new RangeError(`Extra ${t.byteLength-n} of ${t.byteLength} byte(s) found at buffer[${e}]`)}decode(e){if(this.entered)return this.clone().decode(e);try{this.entered=!0,this.reinitializeState(),this.setBuffer(e);const t=this.doDecodeSync();if(this.hasRemaining(1))throw this.createExtraByteError(this.pos);return t}finally{this.entered=!1}}*decodeMulti(e){if(this.entered){yield*this.clone().decodeMulti(e);return}try{for(this.entered=!0,this.reinitializeState(),this.setBuffer(e);this.hasRemaining(1);)yield this.doDecodeSync()}finally{this.entered=!1}}async decodeAsync(e){if(this.entered)return this.clone().decodeAsync(e);try{this.entered=!0;let t=!1,n;for await(const a of e){if(t)throw this.entered=!1,this.createExtraByteError(this.totalPos);this.appendBuffer(a);try{n=this.doDecodeSync(),t=!0}catch(c){if(!(c instanceof RangeError))throw c}this.totalPos+=this.pos}if(t){if(this.hasRemaining(1))throw this.createExtraByteError(this.totalPos);return n}const{headByte:o,pos:r,totalPos:i}=this;throw new RangeError(`Insufficient data in parsing ${Jt(o)} at ${i} (${r} in the current buffer)`)}finally{this.entered=!1}}decodeArrayStream(e){return this.decodeMultiAsync(e,!0)}decodeStream(e){return this.decodeMultiAsync(e,!1)}async*decodeMultiAsync(e,t){if(this.entered){yield*this.clone().decodeMultiAsync(e,t);return}try{this.entered=!0;let n=t,o=-1;for await(const r of e){if(t&&o===0)throw this.createExtraByteError(this.totalPos);this.appendBuffer(r),n&&(o=this.readArraySize(),n=!1,this.complete());try{for(;yield this.doDecodeSync(),--o!==0;);}catch(i){if(!(i instanceof RangeError))throw i}this.totalPos+=this.pos}}finally{this.entered=!1}}doDecodeSync(){e:for(;;){const e=this.readHeadByte();let t;if(e>=224)t=e-256;else if(e<192)if(e<128)t=e;else if(e<144){const o=e-128;if(o!==0){this.pushMapState(o),this.complete();continue e}else t={}}else if(e<160){const o=e-144;if(o!==0){this.pushArrayState(o),this.complete();continue e}else t=[]}else{const o=e-160;t=this.decodeString(o,0)}else if(e===192)t=null;else if(e===194)t=!1;else if(e===195)t=!0;else if(e===202)t=this.readF32();else if(e===203)t=this.readF64();else if(e===204)t=this.readU8();else if(e===205)t=this.readU16();else if(e===206)t=this.readU32();else if(e===207)this.useBigInt64?t=this.readU64AsBigInt():t=this.readU64();else if(e===208)t=this.readI8();else if(e===209)t=this.readI16();else if(e===210)t=this.readI32();else if(e===211)this.useBigInt64?t=this.readI64AsBigInt():t=this.readI64();else if(e===217){const o=this.lookU8();t=this.decodeString(o,1)}else if(e===218){const o=this.lookU16();t=this.decodeString(o,2)}else if(e===219){const o=this.lookU32();t=this.decodeString(o,4)}else if(e===220){const o=this.readU16();if(o!==0){this.pushArrayState(o),this.complete();continue e}else t=[]}else if(e===221){const o=this.readU32();if(o!==0){this.pushArrayState(o),this.complete();continue e}else t=[]}else if(e===222){const o=this.readU16();if(o!==0){this.pushMapState(o),this.complete();continue e}else t={}}else if(e===223){const o=this.readU32();if(o!==0){this.pushMapState(o),this.complete();continue e}else t={}}else if(e===196){const o=this.lookU8();t=this.decodeBinary(o,1)}else if(e===197){const o=this.lookU16();t=this.decodeBinary(o,2)}else if(e===198){const o=this.lookU32();t=this.decodeBinary(o,4)}else if(e===212)t=this.decodeExtension(1,0);else if(e===213)t=this.decodeExtension(2,0);else if(e===214)t=this.decodeExtension(4,0);else if(e===215)t=this.decodeExtension(8,0);else if(e===216)t=this.decodeExtension(16,0);else if(e===199){const o=this.lookU8();t=this.decodeExtension(o,1)}else if(e===200){const o=this.lookU16();t=this.decodeExtension(o,2)}else if(e===201){const o=this.lookU32();t=this.decodeExtension(o,4)}else throw new _e(`Unrecognized type byte: ${Jt(e)}`);this.complete();const n=this.stack;for(;n.length>0;){const o=n.top();if(o.type===en)if(o.array[o.position]=t,o.position++,o.position===o.size)t=o.array,n.release(o);else continue e;else if(o.type===ut){if(t==="__proto__")throw new _e("The key __proto__ is not allowed");o.key=this.mapKeyConverter(t),o.type=Wn;continue e}else if(o.map[o.key]=t,o.readCount++,o.readCount===o.size)t=o.map,n.release(o);else{o.key=null,o.type=ut;continue e}}return t}}readHeadByte(){return this.headByte===ft&&(this.headByte=this.readU8()),this.headByte}complete(){this.headByte=ft}readArraySize(){const e=this.readHeadByte();switch(e){case 220:return this.readU16();case 221:return this.readU32();default:{if(e<160)return e-144;throw new _e(`Unrecognized array type byte: ${Jt(e)}`)}}}pushMapState(e){if(e>this.maxMapLength)throw new _e(`Max length exceeded: map length (${e}) > maxMapLengthLength (${this.maxMapLength})`);this.stack.pushMapState(e)}pushArrayState(e){if(e>this.maxArrayLength)throw new _e(`Max length exceeded: array length (${e}) > maxArrayLength (${this.maxArrayLength})`);this.stack.pushArrayState(e)}decodeString(e,t){return!this.rawStrings||this.stateIsMapKey()?this.decodeUtf8String(e,t):this.decodeBinary(e,t)}decodeUtf8String(e,t){var r;if(e>this.maxStrLength)throw new _e(`Max length exceeded: UTF-8 byte length (${e}) > maxStrLength (${this.maxStrLength})`);if(this.bytes.byteLength<this.pos+t+e)throw Gn;const n=this.pos+t;let o;return this.stateIsMapKey()&&((r=this.keyDecoder)!=null&&r.canBeCached(e))?o=this.keyDecoder.decode(this.bytes,n,e):o=To(this.bytes,n,e),this.pos+=t+e,o}stateIsMapKey(){return this.stack.length>0?this.stack.top().type===ut:!1}decodeBinary(e,t){if(e>this.maxBinLength)throw new _e(`Max length exceeded: bin length (${e}) > maxBinLength (${this.maxBinLength})`);if(!this.hasRemaining(e+t))throw Gn;const n=this.pos+t,o=this.bytes.subarray(n,n+e);return this.pos+=t+e,o}decodeExtension(e,t){if(e>this.maxExtLength)throw new _e(`Max length exceeded: ext length (${e}) > maxExtLength (${this.maxExtLength})`);const n=this.view.getInt8(this.pos+t),o=this.decodeBinary(e,t+1);return this.extensionCodec.decode(o,n,this.context)}lookU8(){return this.view.getUint8(this.pos)}lookU16(){return this.view.getUint16(this.pos)}lookU32(){return this.view.getUint32(this.pos)}readU8(){const e=this.view.getUint8(this.pos);return this.pos++,e}readI8(){const e=this.view.getInt8(this.pos);return this.pos++,e}readU16(){const e=this.view.getUint16(this.pos);return this.pos+=2,e}readI16(){const e=this.view.getInt16(this.pos);return this.pos+=2,e}readU32(){const e=this.view.getUint32(this.pos);return this.pos+=4,e}readI32(){const e=this.view.getInt32(this.pos);return this.pos+=4,e}readU64(){const e=Ro(this.view,this.pos);return this.pos+=8,e}readI64(){const e=Kn(this.view,this.pos);return this.pos+=8,e}readU64AsBigInt(){const e=this.view.getBigUint64(this.pos);return this.pos+=8,e}readI64AsBigInt(){const e=this.view.getBigInt64(this.pos);return this.pos+=8,e}readF32(){const e=this.view.getFloat32(this.pos);return this.pos+=4,e}readF64(){const e=this.view.getFloat64(this.pos);return this.pos+=8,e}}function ht(s,e){return new nn(e).decode(s)}const Ge=new Map,Qe=new Map,Je=new Map,Se=new Map,et=new Map,tt=new Map;let Ae=null;const Mt=new Set(["cancelled","expired","ended","terminated","termination","inferred_cancelled"]),Ho=80,nt=self;async function sn(s){const e=await fetch(s);if(!e.ok)throw new Error(`Failed to fetch ${s}: ${e.status}`);const t=await e.arrayBuffer();return ht(new Uint8Array(t))}function Wo(s){return[...s].sort((e,t)=>{const n=e,o=t,r=String(n.timestamp??"").localeCompare(String(o.timestamp??""));if(r!==0)return r;const i=Number.isFinite(n.event_sequence)?Number(n.event_sequence):Number.POSITIVE_INFINITY,a=Number.isFinite(o.event_sequence)?Number(o.event_sequence):Number.POSITIVE_INFINITY;return i!==a?i-a:String(n.event_id??"").localeCompare(String(o.event_id??""))})}function mt(s,e,t){s[e]||(s[e]=[]),s[e].push(t)}function Go(s){const e={},t={},n={},o={},r={},i=new Map;for(let a=0;a<s.length;a+=1){const c=s[a],d=String(c.action??"unknown"),l=String(c.treaty_type??"unknown"),u=String(c.source??"unknown"),f=Number(c.from_alliance_id??-1),y=Number(c.to_alliance_id??-1);mt(e,d,a),mt(t,l,a),mt(n,u,a),mt(o,String(f),a),f!==y&&mt(o,String(y),a),r[String(c.event_id??a)]=a;const h=i.get(f)??{name:String(c.from_alliance_name??f),count:0};h.count+=1,(!h.name||h.name===String(f))&&(h.name=String(c.from_alliance_name??f)),i.set(f,h);const m=i.get(y)??{name:String(c.to_alliance_name??y),count:0};m.count+=1,(!m.name||m.name===String(y))&&(m.name=String(c.to_alliance_name??y)),i.set(y,m)}return{byAction:e,byType:t,bySource:n,byAlliance:o,eventIdToIndex:r,allActions:Object.keys(e).sort((a,c)=>a.localeCompare(c)),allTypes:Object.keys(t).sort((a,c)=>a.localeCompare(c)),allSources:Object.keys(n).sort((a,c)=>a.localeCompare(c)),alliances:[...i.entries()].map(([a,c])=>({id:a,name:c.name||String(a),count:c.count})).sort((a,c)=>c.count-a.count||a.name.localeCompare(c.name)),minTimestamp:s.length>0?String(s[0].timestamp??""):null,maxTimestamp:s.length>0?String(s[s.length-1].timestamp??""):null}}async function Qo(){const[s,e,t,n,o,r]=await Promise.all([sn(Oe("treaty_changes_reconciled.msgpack")),sn(Oe("treaty_changes_reconciled_summary.msgpack")),sn(Oe("treaty_changes_reconciled_flags.msgpack")),fetch(Oe("alliance_score_ranks_daily.msgpack")).then(async a=>{if(!a.ok)return null;const c=await a.arrayBuffer();return ht(new Uint8Array(c))}).catch(()=>null),fetch(Oe("treaty_frame_index_v1.msgpack")).then(async a=>{if(!a.ok)return null;const c=await a.arrayBuffer();return ht(new Uint8Array(c))}).catch(()=>null),fetch(Oe("manifest.json")).then(async a=>a.ok?await a.json():null).catch(()=>null)]),i=Wo(s);return{eventsRaw:i,indicesRaw:Go(i),summaryRaw:e,flagsRaw:t,scoreRanksRaw:n,frameIndexRaw:o,manifestRaw:r}}function Jo(s){if(!s)return null;const e=ro.safeParse(s);if(!e.success)return console.warn("[timelapse] treaty_frame_index_v1 invalid; falling back to legacy network scan",e.error.message),null;const t=e.data;if(t.day_keys.length===0||t.day_keys.length!==t.event_end_offset_by_day.length||t.day_keys.length!==t.active_edge_delta_by_day.length)return console.warn("[timelapse] treaty_frame_index_v1 shape mismatch; falling back to legacy network scan"),null;const n=new Map;for(let r=0;r<t.edge_dict.length;r+=1){const i=t.edge_dict[r][0];n.set(i,r)}const o=new Map;for(let r=0;r<t.day_keys.length;r+=1)o.set(t.day_keys[r],r);return{payload:t,edgeIdByEventIndex:n,dayIndexByDayKey:o}}function er(s){if(!s||typeof s!="object")return null;const e=s;if(Number(e.schema_version)!==2||!e.ranks_by_day||typeof e.ranks_by_day!="object")return null;const t=e.ranks_by_day,n={};for(const[o,r]of Object.entries(t)){if(!r||typeof r!="object")continue;const i=r,a={};for(const[c,d]of Object.entries(i)){const l=Number(d);if(!Number.isFinite(l))continue;const u=Math.floor(l);u<=0||(a[String(c)]=u)}Object.keys(a).length>0&&(n[o]=a)}return Object.keys(n).length>0?n:null}async function tr(){const[s,e]=await Promise.all([fetch(Oe("flags.msgpack")).then(async t=>{if(!t.ok)return console.warn("[timelapse] Optional flags.msgpack fetch failed in worker",t.status),null;const n=await t.arrayBuffer();return ht(new Uint8Array(n))}).catch(()=>null),fetch(Oe("flag_assets.msgpack")).then(async t=>{if(!t.ok)return console.warn("[timelapse] Optional flag_assets.msgpack fetch failed in worker",t.status),null;const n=await t.arrayBuffer();return ht(new Uint8Array(n))}).catch(()=>null)]);return{allianceFlagsRaw:s,flagAssetsRaw:e}}function yt(s){return bo(s)}function on(s,e){const t=yt(e),n=Ge.get(t);if(n)return n;const o=s.payload.eventsRaw,r={...s.payload.indicesRaw,allEventIndexes:s.allEventIndexes},i=e.filters.topXByScore??null,a=s.scoreRanksByDay,c=i!==null&&i>0&&a?_o(a,i):null,d=vo({events:o,indices:r,query:e,topXMembershipLookup:c}),l=Uint32Array.from(d);if(Ge.set(t,l),Ge.size>80){const u=Ge.keys().next().value;u&&Ge.delete(u)}return l}function nr(s,e,t){return`${s}|pulse:${e}|${t??""}`}function sr(s,e,t,n){const o=yt(e),r=nr(o,t,n),i=Qe.get(r);if(i)return i;const a=s.payload.eventsRaw,c=[...on(s,e)],d=ko(a,c,t,n);if(Qe.set(r,d),Qe.size>80){const l=Qe.keys().next().value;l&&Qe.delete(l)}return d}function or(s,e,t,n,o){return`${yt(s)}|network:${n}:${o}:${e??""}|${t}`}function Qn(s,e,t,n){return`${yt(s)}|network:temporal:${t}:${n}|${e}`}function Jn(s){if(!s)return"none";const e=Object.entries(s).sort(([t],[n])=>t.localeCompare(n)).map(([t,n])=>[t,n]);return JSON.stringify(e)}function Ct(s){return Gt(s)}function rr(s){return s.filters.topXByScore===null?s:{...s,filters:{...s.filters,topXByScore:null}}}function ir(s,e,t){if(!s||e===null||e<=0)return null;const n=Object.keys(s).sort((a,c)=>a.localeCompare(c));if(n.length===0)return null;const o=zn(n,t);if(!o)return null;const r=s[o]??{},i=new Set;for(const[a,c]of Object.entries(r)){const d=Number(a),l=Number(c);!Number.isFinite(d)||!Number.isFinite(l)||d<=0||l<=0||l>e||i.add(d)}return i}function ar(s,e,t,n,o,r){var C;const i=Jn(r),a=or(e,t,n,o,i),c=Je.get(a);if(c)return c;const d=s.payload.eventsRaw,l=rr(e),u=`${yt(l)}|network|${o}|${i}|${n}`,f=Qn(e,n,o,i),y=et.get(f);let h;y&&y.selectionSignature===u?h=y.chronologicalIndexes:(h=[...on(s,l)],h.sort((T,O)=>go(d[T],d[O])));const p=(T=>{if(!T)return h.length;let O=0,Y=h.length;for(;O<Y;){const X=Math.floor((O+Y)/2);d[h[X]].timestamp<=T?O=X+1:Y=X}return O})(t);let g=new Map;const x=y&&y.selectionSignature===u&&y.cursor<=p&&(y.playhead===null||t===null||y.playhead<=t),_=y&&y.selectionSignature===u&&y.cursor>p&&y.cursor-p<=Ho;if(x&&y){g=new Map(y.activeByPair);for(let T=y.cursor;T<p;T+=1){const O=h[T],Y=d[O],X=Ct(Y);Y.action==="signed"?g.set(X,O):Mt.has(Y.action)&&g.delete(X)}}else if(_&&y)for(let T=0;T<p;T+=1){const O=h[T],Y=d[O],X=Ct(Y);Y.action==="signed"?g.set(X,O):Mt.has(Y.action)&&g.delete(X)}else for(let T=0;T<p;T+=1){const O=h[T],Y=d[O],X=Ct(Y);Y.action==="signed"?g.set(X,O):Mt.has(Y.action)&&g.delete(X)}if(et.set(f,{selectionSignature:u,chronologicalIndexes:h,cursor:p,playhead:t,activeByPair:g}),et.size>40){const T=et.keys().next().value;T&&et.delete(T)}let I=[...g.values()];const P=ir(s.scoreRanksByDay,e.filters.topXByScore,t);P&&(I=I.filter(T=>{const O=d[T];return P.has(O.from_alliance_id)&&P.has(O.to_alliance_id)}));const M=Math.max(n,Math.min(200,Math.ceil(n*1.5))),N=qn(I.map(T=>d[T]),M),R=new Map,b=new Set;for(const T of N){const O=String(T.from_alliance_id),Y=String(T.to_alliance_id);b.add(O),b.add(Y);const X=R.get(O)??new Set;X.add(Y),R.set(O,X);const q=R.get(Y)??new Set;q.add(O),R.set(Y,q)}for(const T of b)R.has(T)||R.set(T,new Set);if(P)for(const T of P){const O=String(T);b.has(O)||b.add(O),R.has(O)||R.set(O,new Set)}const E=N.map(T=>s.payload.indicesRaw.eventIdToIndex[T.event_id]),v=Uint32Array.from(E),w=vn(o,{nodeIds:[...b],adjacencyByNodeId:R,temporalKey:f,previousState:Se.get(f),strategyConfig:r}),F=w.layout;if(Se.set(f,(C=w.metadata)==null?void 0:C.state),Se.size>40){const T=Se.keys().next().value;T&&Se.delete(T)}const S={edgeIndexes:v,layout:F};if(Je.set(a,S),Je.size>80){const T=Je.keys().next().value;T&&Je.delete(T)}return S}function cr(s){return!(s.time.start||s.time.end||s.focus.allianceId!==null||s.focus.edgeKey||s.focus.eventId||s.filters.actions.length>0||s.filters.treatyTypes.length>0||s.filters.sources.length>0||s.filters.alliances.length>0||!s.filters.includeInferred||!s.filters.includeNoise||s.filters.evidenceMode!=="all"||s.filters.topXByScore!==null||s.textQuery.trim().length>0)}function dr(s,e){if(s.day_keys.length===0)return-1;if(!e)return s.day_keys.length-1;const t=e.slice(0,10);let n=0,o=s.day_keys.length-1,r=-1;for(;n<=o;){const i=Math.floor((n+o)/2);s.day_keys[i]<=t?(r=i,n=i+1):o=i-1}return r}function lr(s,e){const t="global",n=tt.get(t);let o=new Set,r=0;n&&n.dayIndex<=e&&(o=new Set(n.activeEdgeIds),r=n.dayIndex+1);for(let i=r;i<=e;i+=1){const a=s.payload.active_edge_delta_by_day[i];for(const c of a.remove_edge_ids)o.delete(c);for(const c of a.add_edge_ids)o.add(c)}if(tt.set(t,{dayIndex:e,activeEdgeIds:new Set(o)}),tt.size>8){const i=tt.keys().next().value;i&&tt.delete(i)}return o}function ur(s,e,t,n,o,r){var b;if(!s.frameIndex||!cr(e))return null;const i=s.frameIndex,a=i.payload,c=s.payload.eventsRaw;if(c.length===0||t&&t<c[0].timestamp)return null;const d=dr(a,t);if(d<0)return null;const l=d>0?lr(i,d-1):new Set,u=new Map;for(const E of l){const v=a.edge_dict[E],w=`${v[1]}:${v[2]}:${v[3]}`;u.set(w,E)}const f=d===0?0:a.event_end_offset_by_day[d-1],y=a.event_end_offset_by_day[d]??c.length,h=t||"";for(let E=f;E<y;E+=1){const v=c[E];if(v.timestamp>h)break;const w=Ct(v);if(v.action==="signed"){const F=i.edgeIdByEventIndex.get(E);if(F===void 0)continue;const S=u.get(w);S!==void 0&&l.delete(S),u.set(w,F),l.add(F)}else if(Mt.has(v.action)){const F=u.get(w);F!==void 0&&(l.delete(F),u.delete(w))}}const m=[...l].map(E=>{var v;return(v=a.edge_dict[E])==null?void 0:v[0]}).filter(E=>typeof E=="number"),p=Jn(r),g=`${Qn(e,n,o,p)}|fi:${t??""}`,x=Math.max(n,Math.min(200,Math.ceil(n*1.5))),_=qn(m.map(E=>c[E]),x),I=new Map,P=new Set;for(const E of _){const v=String(E.from_alliance_id),w=String(E.to_alliance_id);P.add(v),P.add(w);const F=I.get(v)??new Set;F.add(w),I.set(v,F);const S=I.get(w)??new Set;S.add(v),I.set(w,S)}for(const E of P)I.has(E)||I.set(E,new Set);const M=_.map(E=>s.payload.indicesRaw.eventIdToIndex[E.event_id]),N=Uint32Array.from(M),R=vn(o,{nodeIds:[...P],adjacencyByNodeId:I,temporalKey:g,previousState:Se.get(g),strategyConfig:r});if(Se.set(g,(b=R.metadata)==null?void 0:b.state),Se.size>40){const E=Se.keys().next().value;E&&Se.delete(E)}return{edgeIndexes:N,layout:R.layout}}function fr(s,e,t,n,o,r){const i=ur(s,e,t,n,o,r);return i||ar(s,e,t,n,o,r)}async function Tt(s){if(Ae&&(!s||Ae.includeFlags))return Ae;if(!Ae){const e=await Qo(),t=er(e.scoreRanksRaw),n=Jo(e.frameIndexRaw),o={...e,allianceFlagsRaw:null,flagAssetsRaw:null},r=new Array(o.eventsRaw.length);for(let i=0;i<o.eventsRaw.length;i+=1)r[i]=i;Ae={payload:o,allEventIndexes:r,includeFlags:!1,scoreRanksByDay:t,frameIndex:n},Ge.clear(),Qe.clear(),Je.clear(),Se.clear(),et.clear(),tt.clear()}if(s&&Ae&&!Ae.includeFlags){const e=await tr();Ae={...Ae,includeFlags:!0,payload:{...Ae.payload,...e}}}return Ae}function hr(s,e){return e?s:{...s,allianceFlagsRaw:null,flagAssetsRaw:null}}function Nt(s){nt.postMessage(s)}function Rt(s,e){return s instanceof Error&&s.message?s.message:e}nt.addEventListener("message",async s=>{const e=s.data;if(e.kind==="load"){try{const t=await Tt(e.includeFlags),n={kind:"load",ok:!0,payload:hr(t.payload,e.includeFlags)};nt.postMessage(n)}catch(t){Nt({kind:"load",ok:!1,error:Rt(t,"Unknown loader worker error")})}return}if(e.kind==="select"){try{const t=await Tt(e.query.filters.showFlags),n=on(t,e.query),o=new Uint32Array(n).buffer,r={kind:"select",ok:!0,requestId:e.requestId,indexesBuffer:o,length:n.length};nt.postMessage(r,[o])}catch(t){Nt({kind:"select",ok:!1,requestId:e.requestId,error:Rt(t,"Unknown selection worker error")})}return}if(e.kind==="network"){try{const t=performance.now(),n=await Tt(e.query.filters.showFlags),o=fr(n,e.query,e.playhead,e.maxEdges,e.strategy,e.strategyConfig),r=performance.now(),i=new Uint32Array(o.edgeIndexes).buffer,a={kind:"network",ok:!0,requestId:e.requestId,startedAt:t,finishedAt:r,edgeIndexesBuffer:i,length:o.edgeIndexes.length,layout:o.layout};nt.postMessage(a,[i])}catch(t){Nt({kind:"network",ok:!1,requestId:e.requestId,error:Rt(t,"Unknown network worker error")})}return}try{const t=await Tt(e.query.filters.showFlags),n=sr(t,e.query,e.maxPoints,e.playhead),o=new Uint32Array(n.length),r=new Uint32Array(n.length),i=new Uint32Array(n.length),a=new Array(n.length);for(let d=0;d<n.length;d+=1){const l=n[d];a[d]=l.day,o[d]=l.signed,r[d]=l.terminal,i[d]=l.inferred}const c={kind:"pulse",ok:!0,requestId:e.requestId,days:a,signedBuffer:o.buffer,terminalBuffer:r.buffer,inferredBuffer:i.buffer,length:n.length};nt.postMessage(c,[c.signedBuffer,c.terminalBuffer,c.inferredBuffer])}catch(t){Nt({kind:"pulse",ok:!1,requestId:e.requestId,error:Rt(t,"Unknown pulse worker error")})}})})();
